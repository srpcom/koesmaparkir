<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIPARKIR KOESMA - RSUD dr. R. Koesma</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/srpcom/koesmaparkir/main/new%20logo%20rsud%202025%20kecil.png">
    
    <!-- Libraries -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- VARIABLE & GLOBAL --- */
        :root {
            /* Palette Blue Emerald */
            --primary-color: #005A9C; 
            --primary-dark: #003d6b;
            --emerald-accent: #00d2ff;
            --glass-border: rgba(255, 255, 255, 0.3);
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-card-bg: rgba(255, 255, 255, 0.1);
            
            --success-color: #28a745; 
            --error-color: #dc3545;
            --border-radius: 16px;
            --font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body { 
            font-family: var(--font-family); 
            background-color: #0f172a; /* Fallback color */
            margin: 0; min-height: 100vh;
            display: flex; flex-direction: column;
            overflow-x: hidden;
        }

        /* Background Image dengan Overlay Gelap & Emerald */
        body::before {
            content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-image: url('https://raw.githubusercontent.com/srpcom/koesmaparkir/main/foto%20ipit.jpg'); 
            background-size: cover; background-position: center; background-attachment: fixed;
            filter: blur(4px) brightness(0.3); /* Dibuat lebih gelap agar efek neon menyala */
            z-index: -2;
        }

        /* Gradient Overlay untuk nuansa Biru/Emerald */
        body::after {
            content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(0, 20, 40, 0.8), rgba(0, 90, 156, 0.3));
            z-index: -1;
            pointer-events: none;
        }

        /* --- LOGIN PAGE (Blue Emerald Glass 3D) --- */
        #login-page { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; justify-content: center; align-items: center; 
            z-index: 2000; transition: opacity 0.5s ease, visibility 0.5s;
            overflow: hidden;
            perspective: 1000px; /* Enable 3D perspective */
        }

        /* --- NEW: CANVAS FOR SMART SENSOR MESH --- */
        #sensorMeshCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1; /* Di atas background, di bawah kartu */
            pointer-events: none;
        }

        /* Decorative Orbs (Bola Cahaya) - Adjusted opacity for Mesh visibility */
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px); /* Blur lebih kuat agar tidak mengganggu mesh */
            z-index: 0; 
            opacity: 0.3;
            animation: floatOrb 10s infinite ease-in-out alternate;
        }
        .orb-1 { width: 300px; height: 300px; background: #005A9C; top: -50px; left: -50px; animation-duration: 8s; }
        .orb-2 { width: 250px; height: 250px; background: #00d2ff; bottom: -50px; right: -50px; animation-duration: 12s; }
        .orb-3 { width: 150px; height: 150px; background: #28a745; bottom: 20%; left: 20%; animation-duration: 15s; opacity: 0.2; }

        @keyframes floatOrb {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(30px, 50px) scale(1.1); }
        }

        .login-card { 
            position: relative;
            z-index: 10; /* Pastikan di atas canvas */
            background: rgba(10, 20, 35, 0.65); /* Dark Glass */
            backdrop-filter: blur(15px); 
            -webkit-backdrop-filter: blur(15px);
            padding: 50px 40px; 
            border-radius: 24px; 
            text-align: center; 
            width: 90%; max-width: 420px;
            
            /* Glass Border Effect - Lebih tegas */
            border: 1px solid rgba(0, 210, 255, 0.2);
            box-shadow: 0 0 30px rgba(0, 90, 156, 0.2), inset 0 0 20px rgba(0, 210, 255, 0.05);
            
            transform-style: preserve-3d;
            animation: cardEntrance 0.8s ease-out forwards;
        }

        @keyframes cardEntrance {
            from { opacity: 0; transform: translateY(50px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .login-logo {
            width: 90px; margin-bottom: 20px;
            filter: drop-shadow(0 0 15px rgba(255,255,255,0.6));
            transition: transform 0.3s;
        }
        .login-logo:hover { transform: scale(1.1) rotate(5deg); }

        .login-title {
            color: #ffffff; margin: 0; font-size: 1.8rem; font-weight: 800;
            text-shadow: 0 0 15px rgba(0, 210, 255, 0.5); /* Neon Text Shadow */
            letter-spacing: 1px;
        }

        .login-subtitle {
            color: #e0f2fe; margin: 10px 0 30px; font-size: 0.95em; font-weight: 300;
            opacity: 0.9;
        }

        /* Container untuk Google Button agar rapi */
        .g-btn-wrapper {
            background: rgba(255, 255, 255, 0.9);
            padding: 5px;
            border-radius: 50px;
            display: inline-block;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        .g-btn-wrapper:hover { transform: translateY(-2px); box-shadow: 0 0 20px rgba(0, 210, 255, 0.4); }


        /* --- MAIN APP CONTAINER --- */
        .container { 
            max-width: 1000px; width: 95%; margin: 30px auto; 
            background-color: rgba(255, 255, 255, 0.92); /* Sedikit transparan */
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius); 
            box-shadow: 0 15px 35px rgba(0,0,0,0.3); 
            overflow: hidden;
            transition: all 0.3s ease-in-out;
            border: 1px solid rgba(255,255,255,0.4);
            position: relative; z-index: 10;
        }

        .container.admin-mode {
            max-width: 100%; width: 100%; margin: 0; border-radius: 0; min-height: 100vh;
            background-color: #f8f9fa;
        }

        header { 
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); 
            color: white; padding: 20px; text-align: center; 
            display: flex; align-items: center; justify-content: center; gap: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        header img { width: 50px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
        header div { text-align: left; }
        header h1 { margin: 0; font-size: 1.4rem; font-weight: 700; letter-spacing: 1px; }
        header p { margin: 0; font-size: 0.9rem; opacity: 0.9; font-weight: 300; }

        /* SEARCH BAR */
        .search-container { position: relative; flex: 1; max-width: 400px; }
        .search-container input { width: 100%; padding: 12px 12px 12px 45px; border-radius: 30px; border: 1px solid #ddd; transition: all 0.3s; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); }
        .search-container input:focus { box-shadow: 0 0 0 3px rgba(0, 90, 156, 0.2); border-color: var(--primary-color); }
        .search-container i.fa-search { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: var(--primary-color); }
        .search-container i.fa-times { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #ccc; cursor: pointer; display: none; }
        .search-container input:not(:placeholder-shown) + i.fa-times { display: block; }

        th.sortable { cursor: pointer; user-select: none; position: relative; padding-right: 20px; }
        th.sortable:hover { background-color: #e9ecef; color: var(--primary-color); }
        th.sortable .sort-icon { margin-left: 5px; font-size: 0.8em; color: #888; }
        
        .swal2-container { z-index: 9999 !important; }

        /* DASHBOARD USER */
        .dashboard-header { padding: 20px; background: rgba(255,255,255,0.6); border-bottom: 1px solid #eee; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 10px; }
        .user-profile-summary { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 50px; height: 50px; background: linear-gradient(135deg, var(--primary-color), var(--emerald-accent)); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5em; font-weight: bold; box-shadow: 0 3px 10px rgba(0,90,156,0.3); }
        .user-info h3 { margin: 0; font-size: 1.1em; color: var(--primary-dark); }
        .user-info span { font-size: 0.85em; color: #666; }
        
        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; }
        .btn-small { padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd; background: white; cursor: pointer; font-size: 0.9em; transition: 0.2s; display: flex; align-items: center; gap: 5px; font-weight: 600; }
        .btn-small:hover { transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-logout { color: var(--error-color); border-color: #ffdce0; background: #fff0f1; }
        .btn-edit-profile { color: var(--primary-color); border-color: #d0ebff; background: #e7f5ff; }
        .btn-add-user { background: #212529; color: white; border-color: #000; }
        
        .btn-status-on { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .btn-status-off { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }

        /* LINK TELEPON DI TABEL */
        a.phone-link { 
            color: var(--success-color); font-weight: bold; text-decoration: none; 
            border-bottom: 1px dashed var(--success-color); transition: all 0.2s;
        }
        a.phone-link:hover { background-color: #f0fff4; border-bottom-style: solid; }

        .optional-col { display: none; }
        .table-detailed .optional-col { display: table-cell; }

        .btn-toggle-detail { background-color: #6c757d; color: white; border: none; }
        .btn-toggle-detail.active { background-color: var(--primary-color); }

        .dashboard-content { padding: 25px; }
        .section-title { font-size: 1.2em; font-weight: bold; margin-bottom: 20px; border-left: 5px solid var(--primary-color); padding-left: 15px; color: #333; display: flex; align-items: center; gap: 10px; }

        /* Vehicle Grid */
        .vehicle-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .vehicle-card { 
            background: white; border: none; border-radius: 12px; padding: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; 
            border-left: 5px solid var(--primary-color); transition: transform 0.2s;
        }
        .vehicle-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .v-nopol { font-size: 1.5em; font-weight: 800; color: #2c3e50; display: block; letter-spacing: 1px; }
        .v-info { font-size: 0.95em; color: #666; display: block; margin-top: 5px; }
        .v-status { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.75em; font-weight: bold; text-transform: uppercase; float: right; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        .btn-float-add { 
            display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; 
            background: linear-gradient(to right, var(--primary-color), var(--primary-dark)); 
            color: white; padding: 18px; border-radius: 12px; border: none; 
            font-size: 1.1em; font-weight: bold; cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0,90,156, 0.3); transition: 0.3s; 
        }
        .btn-float-add:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,90,156, 0.4); }

        /* MODAL COMMON */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); z-index: 2500; display: none; 
            justify-content: center; align-items: flex-start; 
            overflow-y: auto; padding: 20px 0; 
            backdrop-filter: blur(8px); 
        }
        .modal-content { 
            background: white; width: 95%; max-width: 600px; 
            border-radius: 20px; overflow: hidden; animation: zoomIn 0.3s; 
            margin: auto; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.2); 
        }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-header { background: #f8f9fa; padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; color: #333; font-size: 1.2rem; }
        .btn-close { background: none; border: none; font-size: 1.8em; cursor: pointer; color: #888; transition: color 0.2s; }
        .btn-close:hover { color: var(--error-color); }
        
        form { padding: 25px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9em; color: #444; }
        
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 1em; box-sizing: border-box; background-color: #fdfdfd; transition: border 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(0,90,156,0.1); }

        input[type="file"] { padding: 8px; background: #f9f9f9; cursor: pointer; border: 1px dashed #ccc; }
        input[type="file"]::file-selector-button { margin-right: 15px; border: none; background: var(--primary-color); padding: 8px 16px; border-radius: 6px; color: #fff; cursor: pointer; font-weight: bold; transition: background .2s ease-in-out; }
        
        .btn-submit { width: 100%; padding: 14px; background: linear-gradient(to right, var(--success-color), #218838); color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 1.1em; cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3); }
        .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(40, 167, 69, 0.4); }

        /* Admin Styles */
        .admin-tabs { display: flex; background: white; border-bottom: 1px solid #ddd; padding: 0 10px; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab-btn:hover { color: var(--primary-color); background: #f8f9fa; }
        .tab-btn.active { border-bottom: 3px solid var(--primary-color); color: var(--primary-color); background: #f0f7ff; }
        .admin-panel { display: none; padding: 20px; background: white; min-height: 400px; }
        .admin-panel.active { display: block; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.85em; margin-top: 15px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        th { background: #f1f3f5; padding: 15px 10px; text-align: left; font-weight: 700; color: #495057; text-transform: uppercase; font-size: 0.85em; }
        td { padding: 12px 10px; border-bottom: 1px solid #eee; vertical-align: middle; }

        tr.row-pending td { background-color: #fff9db !important; color: #664d03; } 
        tr.row-approved td { background-color: #d3f9d8 !important; color: #0b2e13; } 
        tr.row-rejected td { background-color: #ffe3e3 !important; color: #842029; }
        
        .status-select { padding: 6px; border-radius: 6px; border: 1px solid rgba(0,0,0,0.1); font-weight: bold; background: rgba(255,255,255,0.7); cursor: pointer; width: 100%; max-width: 140px; }
        .status-cell-content { display: flex; align-items: center; gap: 5px; }

        .hidden { display: none !important; }
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8em; font-weight: bold; letter-spacing: 0.5px; }
        .st-active { background: #e6fcf5; color: #087f5b; border: 1px solid #b2f2bb; }
        .st-blocked { background: #fff5f5; color: #c92a2a; border: 1px solid #ffc9c9; }
        
        .role-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75em; text-transform: uppercase; font-weight: bold; }
        .role-super { background: #212529; color: #fff; }
        .role-admin { background: #1971c2; color: #fff; }
        .role-user { background: #e9ecef; color: #495057; }
        
        .btn-action { padding: 5px 10px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.8em; margin-right: 3px; font-weight: 600; }
        .btn-promote { background: #fff3bf; color: #f08c00; }
        .btn-demote { background: #e9ecef; color: #666; }
        .btn-block { background: #ffe3e3; color: #e03131; }
        .btn-unblock { background: #d3f9d8; color: #2b8a3e; }
        .btn-edit { background: #d0ebff; color: var(--primary-color); }

        @media (max-width: 768px) {
            .container { width: 100%; margin: 0; border-radius: 0; box-shadow: none; }
            table, thead, tbody, th, td, tr { display: block; }
            thead { display: none; }
            tr { border: 1px solid #eee; margin-bottom: 15px; padding: 15px; border-radius: 12px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
            td { display: flex; justify-content: space-between; border: none; padding: 8px 0; flex-wrap: wrap; align-items: center; }
            td::before { content: attr(data-label); font-weight: bold; color: #777; width: 40%; font-size: 0.9em; }
            .optional-col { display: none !important; }
            .table-detailed .optional-col { display: flex !important; }
            .login-card { width: 85%; padding: 40px 20px; }
        }
    </style>
</head>
<body>

    <!-- LOGIN PAGE (3D Glass Style) -->
    <div id="login-page">
        <!-- SMART SENSOR MESH CANVAS -->
        <canvas id="sensorMeshCanvas"></canvas>

        <!-- Elemen Dekorasi 3D Orbs (Tetap ada sebagai background ambience) -->
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>

        <div class="login-card">
            <img src="https://raw.githubusercontent.com/srpcom/koesmaparkir/main/new%20logo%20rsud%202025%20kecil.png" alt="Logo" class="login-logo">
            <h2 class="login-title">SIPARKIR KOESMA</h2>
            <p class="login-subtitle">Sistem Informasi Parkir<br>RSUD dr. R. Koesma Tuban</p>
            
            <div class="g-btn-wrapper">
                <div id="g_id_onload" 
                     data-client_id="783459415718-mp0vsmd2lopajf2ut0aqc6drjrs95pu8.apps.googleusercontent.com" 
                     data-callback="handleCredentialResponse" 
                     data-auto_prompt="false">
                </div>
                <div class="g_id_signin" 
                     data-type="standard" 
                     data-size="large" 
                     data-theme="outline" 
                     data-text="sign_in_with" 
                     data-shape="pill" 
                     data-logo_alignment="left">
                </div>
            </div>
            <p style="margin-top:20px; font-size:0.8em; color:rgba(255,255,255,0.6);">Silakan login menggunakan akun Google Anda.</p>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="app-container" class="container hidden">
        <header>
            <img src="https://raw.githubusercontent.com/srpcom/koesmaparkir/main/new%20logo%20rsud%202025%20kecil.png" alt="Logo">
            <div>
                <h1>SIPARKIR KOESMA</h1>
                <p>Sistem Informasi Parkir RSUD dr. R. Koesma Tuban</p>
            </div>
        </header>

        <!-- USER DASHBOARD -->
        <div id="user-dashboard">
            <div class="dashboard-header">
                <div class="user-profile-summary">
                    <div class="user-avatar" id="avatar-initials">U</div>
                    <div class="user-info">
                        <h3 id="display-name">User Name</h3>
                        <span id="display-unit">Unit Kerja</span>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn-small btn-edit-profile" onclick="openProfileModal(true)">Edit Profil</button>
                    <button class="btn-small btn-logout" onclick="handleLogout()">Keluar</button>
                </div>
            </div>
            <div class="dashboard-content">
                <div class="section-title"><i class="fas fa-history"></i> Riwayat Pengajuan</div>
                <div id="loading-vehicles" style="text-align:center; padding:40px;">
                    <i class="fas fa-spinner fa-spin fa-2x" style="color:var(--primary-color)"></i>
                    <p style="color:#666; margin-top:10px;">Memuat data...</p>
                </div>
                <div id="vehicle-list" class="vehicle-grid"></div>
                <div id="empty-state" class="hidden" style="text-align:center; padding:50px; color:#999; border: 2px dashed #eee; border-radius: 12px;">
                    <i class="fas fa-clipboard-list fa-3x" style="color:#ddd; margin-bottom:15px;"></i>
                    <p>Belum ada data pengajuan.</p>
                </div>
                <button class="btn-float-add" onclick="openSubmissionModal()">
                    <i class="fas fa-plus-circle"></i> Ajukan Layanan Parkir
                </button>
            </div>
        </div>

        <!-- ADMIN DASHBOARD -->
        <div id="admin-dashboard" class="hidden">
            <div class="dashboard-header" style="background:#e3f2fd;">
                <div>
                    <h3 style="color:#00487a">Dashboard Admin</h3>
                    <span id="admin-role-badge" class="role-badge role-admin">ADMIN</span>
                </div>
                <div class="action-buttons">
                    <button id="btn-toggle-status" class="btn-small btn-status-on" onclick="toggleFormStatus()">
                        <i class="fas fa-toggle-on"></i> Formulir: Loading...
                    </button>
                    
                    <button class="btn-small btn-edit-profile" onclick="openAdminOfflineInput()">
                        <i class="fas fa-keyboard"></i> Input Offline
                    </button>
                    <button class="btn-small btn-logout" onclick="handleLogout()">Keluar</button>
                </div>
            </div>
            <div class="admin-tabs">
                <button class="tab-btn active" id="btn-tab-submissions" onclick="switchTab('submissions')">Data Pengajuan</button>
                <button class="tab-btn" id="btn-tab-users" onclick="switchTab('users')">Manajemen User</button>
            </div>
            
            <!-- TAB SUBMISSIONS -->
            <div id="tab-submissions" class="admin-panel active">
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="search-input" placeholder="Cari Nama/Nopol/Reg...">
                        <i class="fas fa-times" id="clear-search" onclick="clearSearch()"></i>
                    </div>
                    
                    <select id="status-filter" style="width: auto; flex-shrink: 0; padding:12px; border-radius:30px;" onchange="fetchSubmissions(1)">
                        <option value="Semua">Semua Status</option>
                        <option value="Belum diproses">Belum diproses</option>
                        <option value="Selesai">Selesai</option>
                        <option value="Ditolak">Ditolak</option>
                    </select>
                    
                    <button onclick="fetchSubmissions(1)" class="btn-small" style="height: 45px; border-radius:30px;"><i class="fas fa-sync-alt"></i></button>

                    <!-- TOMBOL TAMPILKAN DETAIL -->
                    <button id="btn-detail-toggle" onclick="toggleDetails()" class="btn-small btn-toggle-detail" style="height: 45px; border-radius:30px;">
                        <i class="fas fa-eye"></i> Detail
                    </button>
                </div>

                <div style="overflow-x:auto;">
                    <table id="submissions-table">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="pagination-controls" style="margin-top:20px; text-align:center;"></div>
            </div>

            <!-- TAB USERS -->
            <div id="tab-users" class="admin-panel">
                <button onclick="fetchUsers()" class="btn-small" style="margin-bottom:15px;"><i class="fas fa-sync-alt"></i> Refresh User</button>
                <button onclick="openAddUserModal()" class="btn-small btn-add-user hidden" id="btn-add-user-admin" style="margin-bottom:15px; margin-left:10px;"><i class="fas fa-user-plus"></i> Tambah User</button>
                
                <div style="overflow-x:auto;">
                    <table id="users-table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Nama</th>
                                <th>No. HP</th> 
                                <th>Role</th>
                                <th>Status</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PROFIL (User & Admin Input) -->
    <div id="profile-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-id-card"></i> Data User</h3>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button id="logout-profile-btn" class="btn-small btn-logout hidden" onclick="handleLogout()" style="padding:5px 10px; font-size:0.8em;">
                        <i class="fas fa-sign-out-alt"></i> Keluar
                    </button>
                    <button id="close-profile-btn" class="btn-close" onclick="closeProfileModal()">&times;</button>
                </div>
            </div>
            <form id="profileForm">
                <input type="hidden" id="prof-target-email"> 
                <div class="form-group">
                    <label>Nama Lengkap (Sesuai KTP)</label>
                    <input type="text" id="prof-nama" required>
                </div>
                <div class="form-group">
                    <label>Status Kepegawaian</label>
                    <select id="prof-status" onchange="toggleUnitInput()" required>
                        <option value="">-- Pilih --</option>
                        <option value="Karyawan RSUD">Karyawan RSUD</option>
                        <option value="Pihak Ketiga">Pihak Ketiga / Lainnya</option>
                    </select>
                </div>

                <!-- Container untuk Karyawan RSUD -->
                <div id="prof-rsud-container" class="hidden">
                    <div class="form-group">
                        <label>Unit Kerja (Bidang/Bagian/Ruangan)</label>
                        <!-- DAFTAR UNIT KERJA LENGKAP -->
                        <select id="prof-unit-rsud" onchange="toggleRSUDUnit()">
                            <option value="">-- Pilih Unit --</option>
                            <option value="INSTALASI FARMASI">INSTALASI FARMASI</option>
                            <option value="INSTALASI RADIOLOGI">INSTALASI RADIOLOGI</option>
                            <option value="INSTALASI BEDAH SENTRAL">INSTALASI BEDAH SENTRAL</option>
                            <option value="INSTALASI GAWAT DARURAT">INSTALASI GAWAT DARURAT</option>
                            <option value="ICU">ICU</option>
                            <option value="ICCU">ICCU</option>
                            <option value="HCU">HCU</option>
                            <option value="INSTALASI LABORATORIUM">INSTALASI LABORATORIUM</option>
                            <option value="INSTALASI HEMODIALISA">INSTALASI HEMODIALISA</option>
                            <option value="INSTALASI GIZI">INSTALASI GIZI</option>
                            <option value="INSTALASI REKAM MEDIK">INSTALASI REKAM MEDIK</option>
                            <option value="INSTALASI PEMELIHARAAN SARANA">INSTALASI PEMELIHARAAN SARANA</option>
                            <option value="INSTALASI PENYEHATAN LINGKUNGAN">INSTALASI PENYEHATAN LINGKUNGAN</option>
                            <option value="INSTALASI FORENSIK DAN MEDIKOLEGAL">INSTALASI FORENSIK DAN MEDIKOLEGAL</option>
                            <option value="INSTALASI DIAGNOSTIK DAN INTERVENSI KORDIOVASKULER">INSTALASI DIAGNOSTIK DAN INTERVENSI KORDIOVASKULER</option>
                            <option value="INSTALASI MATERNAL DAN PERINATAL">INSTALASI MATERNAL DAN PERINATAL</option>
                            <option value="INSTALASI REHABILITASI MEDIK">INSTALASI REHABILITASI MEDIK</option>
                            <option value="INSTALASI SIM RS">INSTALASI SIM RS</option>
                            <option value="INSTALASI PKRS">INSTALASI PKRS</option>
                            <option value="POLI KIR">POLI KIR</option>
                            <option value="POLI EKSKUTIF">POLI EKSKUTIF</option>
                            <option value="POLI TMS">POLI TMS</option>
                            <option value="POLI EEG">POLI EEG</option>
                            <option value="POLI ENDOSKOPI">POLI ENDOSKOPI</option>
                            <option value="POLI ESWL">POLI ESWL</option>
                            <option value="RUANG MAWAR/ASTER">RUANG MAWAR/ASTER</option>
                            <option value="RUANG ANYELIR/MELATI">RUANG ANYELIR/MELATI</option>
                            <option value="RUANG ANGGREK/DAHLIA">RUANG ANGGREK/DAHLIA</option>
                            <option value="RUANG BOUGENVILLE">RUANG BOUGENVILLE</option>
                            <option value="RUANG TERATAI/ASOKA">RUANG TERATAI/ASOKA</option>
                            <option value="RUANG LILY">RUANG LILY</option>
                            <option value="RUANG FLAMBOYAN">RUANG FLAMBOYAN</option>
                            <option value="POLI ANAK">POLI ANAK</option>
                            <option value="POLI PENYAKIT DALAM">POLI PENYAKIT DALAM</option>
                            <option value="POLI BEDAH">POLI BEDAH</option>
                            <option value="POLI MATA">POLI MATA</option>
                            <option value="POLI THT">POLI THT</option>
                            <option value="POLI SYARAF">POLI SYARAF</option>
                            <option value="POLI JANTUNG">POLI JANTUNG</option>
                            <option value="POLI PARU">POLI PARU</option>
                            <option value="POLI GIGI">POLI GIGI</option>
                            <option value="POLI KULIT DAN KELAMIN">POLI KULIT DAN KELAMIN</option>
                            <option value="POLI JIWA">POLI JIWA</option>
                            <option value="POLI TB">POLI TB</option>
                            <option value="POLI VCT">POLI VCT</option>
                            <option value="POLI UMUM">POLI UMUM</option>
                            <option value="POLI GERIATRI">POLI GERIATRI</option>
                            <option value="POLI UROLOGI">POLI UROLOGI</option>
                            <option value="POLI ORTHOPEDI">POLI ORTHOPEDI</option>
                            <option value="POLI OBSGYN">POLI OBSGYN</option>
                            <option value="POLI BEDAH SYARAF">POLI BEDAH SYARAF</option>
                            <option value="BAGIAN PROGPEL">BAGIAN PROGPEL</option>
                            <option value="BAGIAN KEUANGAN">BAGIAN KEUANGAN</option>
                            <option value="BAGIAN ADMINISTRASI DAN UMUM">BAGIAN ADMINISTRASI DAN UMUM</option>
                            <option value="BIDANG PELAYANAN MEDIK">BIDANG PELAYANAN MEDIK</option>
                            <option value="BIDANG KEPERAWATAN">BIDANG KEPERAWATAN</option>
                            <option value="BIDANG PELAYANAN PENUNJANG">BIDANG PENUNJANG</option>
                            <option value="KOMITE MEDIK">KOMITE MEDIK</option>
                            <option value="KOMITE KEPERAWATAN">KOMITE KEPERAWATAN</option>
                            <option value="KOMITE PPI">KOMITE PPI</option>
                            <option value="KOMITE KESEHATAN DAN KESELAMATAN KERJA">KOMITE KESEHATAN DAN KESELAMATAN KERJA</option>
                            <option value="SATUAN PEMERIKSAAN INTERNAL">SATUAN PEMERIKSAAN INTERNAL</option>
                            <option value="UNIT AMBULAN">UNIT AMBULAN</option>
                            <option value="UNIT LOUNDRY">UNIT LOUNDRY</option>
                            <option value="UNIT CSSD">UNIT CSSD</option>
                            <option value="UNIT PENGADUAN">UNIT PENGADUAN</option>
                            <option value="UNIT DIKLAT">UNIT DIKLAT</option>
                            <option value="UNIT KLAIM DAN PENJAMINAN">UNIT KLAIM DAN PENJAMINAN</option>
                            <option value="LAINNYA">Lainnya...</option>
                        </select>
                    </div>
                    <div class="form-group hidden" id="prof-unit-rsud-manual-container">
                        <label>Nama Unit (Manual)</label>
                        <input type="text" id="prof-unit-rsud-manual" placeholder="Tulis nama unit...">
                    </div>
                </div>

                <!-- Container untuk Pihak Ketiga -->
                <div id="prof-pihak-ketiga-container" class="hidden">
                    <div class="form-group">
                        <label>Nama Instansi / Perusahaan</label>
                        <input type="text" id="prof-instansi-luar" placeholder="Contoh: PT. Aman Jaya">
                    </div>
                    <div class="form-group">
                        <label>Bertugas di RSUD Sampai Dengan</label>
                        <input type="date" id="prof-tgl-selesai">
                    </div>
                </div>

                <div class="form-group">
                    <label>No. HP / WhatsApp</label>
                    <input type="tel" id="prof-hp" placeholder="08xxxxxxxxxx" required>
                </div>
                <div class="form-group">
                    <label>Upload Foto KTP/SIM (Sekali saja)</label>
                    <input type="file" id="prof-file" accept="image/*">
                    <small id="ktp-status" style="color:green; display:none; margin-top:5px;">
                        <i class="fas fa-check-circle"></i> Sudah ada file KTP.
                    </small>
                </div>
                <button type="submit" class="btn-submit">Simpan Profil</button>
            </form>
        </div>
    </div>

    <!-- MODAL ADMIN INPUT EMAIL -->
    <div id="admin-input-modal" class="modal-overlay">
        <div class="modal-content" style="max-width:400px;">
            <div class="modal-header">
                <h3>Input Offline</h3>
                <button class="btn-close" onclick="document.getElementById('admin-input-modal').style.display='none'">&times;</button>
            </div>
            <div style="padding:20px;">
                <p>Masukkan Email User (Pemilik Kendaraan):</p>
                <input type="email" id="offline-email-input" placeholder="user@gmail.com" style="margin-bottom:15px;">
                <button class="btn-submit" onclick="checkOfflineUser()">Cek & Lanjut</button>
            </div>
        </div>
    </div>

    <!-- MODAL PENGAJUAN -->
    <div id="submission-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-parking"></i> Ajukan Layanan</h3>
                <button class="btn-close" onclick="closeSubmissionModal()">&times;</button>
            </div>
            <div style="padding:10px 20px; background:#e8f4fc; display:none;" id="sub-admin-notice">
                <small><strong>Mode Admin:</strong> Mengajukan atas nama <span id="sub-target-user"></span></small>
            </div>
            <form id="submissionForm">
                <input type="hidden" id="sub-target-email-hidden">

                <div class="form-group">
                    <label>Tujuan Pengajuan</label>
                    <select id="sub-tujuan" onchange="toggleSubFields()" required>
                        <option value="">-- Pilih Tujuan --</option>
                        <option value="Pendaftaran Baru">Daftar Kendaraan Baru</option>
                        <option value="Rubah Nomor Kendaraan">Ganti Plat Nomor</option>
                        <option value="Hapus Nomor Kendaraan">Hapus Kendaraan</option> 
                        <option value="Buat/Ganti Kartu Parkir">Kartu Hilang/Rusak</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                </div>
                <div id="sub-kendaraan-baru" class="hidden">
                    <div class="form-group">
                        <label>Jenis Kendaraan</label>
                        <select id="sub-jenis">
                            <option value="Motor">Motor</option>
                            <option value="Mobil">Mobil</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Nomor Polisi (Baru)</label>
                        <input type="text" id="sub-nopol-baru" style="text-transform:uppercase;" placeholder="CTH: S 1234 XX">
                    </div>
                </div>
                <div id="sub-kendaraan-lama" class="hidden form-group">
                    <label id="lbl-nopol-lama">Nomor Polisi Lama</label>
                    <input type="text" id="sub-nopol-lama" style="text-transform:uppercase;" placeholder="CTH: S1234XX">
                </div>
                <div class="form-group">
                    <label>Keterangan Tambahan</label>
                    <textarea id="sub-ket" rows="2"></textarea>
                </div>
                <button type="submit" class="btn-submit">Kirim Pengajuan</button>
            </form>
        </div>
    </div>

    <!-- FOOTER BARU -->
    <footer style="background: rgba(0, 60, 110, 0.9); backdrop-filter:blur(5px); color: white; text-align: center; padding: 20px; font-size: 0.9em; margin-top: auto;">
        <p style="margin:0;">&copy; 2026 SIPARKIR KOESMA - RSUD dr. R. Koesma Tuban</p>
    </footer>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxGXkhavdS4mFvczIUQNxv0xEodHX28VFMYboSq6LnE7RXxQ-guNA_s7TfsE0zWlrLXTw/exec';
        
        let userProfile = null;
        let currentUserEmail = '';
        let currentUserRole = 'USER';
        let offlineTargetEmail = ''; 
        let offlineUserProfile = null;
        let currentFormStatus = 'ON';
        let currentSortCol = '', currentSortDir = 'asc', searchTimeout = null;
        let clientIP = 'Tidak Terdeteksi'; 
        let showDetailsMode = false;
        
        // Simpan data semua user untuk akses edit cepat
        let allUsersData = [];

        function setupNopolFormatter(inputId) {
            const el = document.getElementById(inputId);
            if(el) {
                el.addEventListener('input', function(e) {
                    let val = this.value.toUpperCase();
                    val = val.replace(/[^A-Z0-9]/g, ''); 
                    this.value = val;
                });
            }
        }
        
        async function fetchClientIP() {
            try {
                const res = await fetch('https://api.ipify.org?format=json');
                const json = await res.json();
                clientIP = json.ip;
                console.log('IP Detected:', clientIP);
            } catch (e) { console.warn('Gagal ambil IP:', e); }
        }

        window.addEventListener('load', () => {
            fetchClientIP();
            const savedEmail = localStorage.getItem('userEmail');
            const savedName = localStorage.getItem('userName');

            if (savedEmail && savedName) {
                // Hentikan animasi mesh jika login tersimpan
                if(window.meshAnimationId) cancelAnimationFrame(window.meshAnimationId);
                
                // Efek transisi halus
                document.getElementById('login-page').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('login-page').classList.add('hidden');
                }, 500);
                currentUserEmail = savedEmail;
                checkUserBackend(savedEmail, savedName);
            }
            
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => { fetchSubmissions(1); }, 500); 
                });
            }
            setupNopolFormatter('sub-nopol-baru');
            setupNopolFormatter('sub-nopol-lama');
        });

        function handleCredentialResponse(response) {
            // Hentikan animasi mesh
            if(window.meshAnimationId) cancelAnimationFrame(window.meshAnimationId);
            
            // Efek transisi halus saat login
            const loginPage = document.getElementById('login-page');
            loginPage.style.opacity = '0';
            setTimeout(() => { loginPage.classList.add('hidden'); }, 500);

            const payload = JSON.parse(atob(response.credential.split('.')[1]));
            currentUserEmail = payload.email;
            
            localStorage.setItem('userEmail', payload.email);
            localStorage.setItem('userName', payload.name);
            
            checkUserBackend(payload.email, payload.name);
        }

        async function checkUserBackend(email, googleName) {
            if (!Swal.isVisible()) Swal.fire({ title: 'Memuat Profil...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            const userDevice = navigator.userAgent;
            
            try {
                const res = await fetch(`${WEB_APP_URL}?action=checkUser&email=${encodeURIComponent(email)}&name=${encodeURIComponent(googleName)}&ip=${encodeURIComponent(clientIP)}&device=${encodeURIComponent(userDevice)}`);
                const json = await res.json();
                Swal.close();
                
                if (json.status === 'blocked') {
                    localStorage.clear();
                    Swal.fire('Ditolak', 'Akun diblokir.', 'error').then(() => location.reload());
                    return;
                }
                
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                userProfile = json.profile;
                currentUserRole = json.role || 'USER';
                
                if (currentUserRole === 'SUPERADMIN' || currentUserRole === 'ADMIN') {
                    initAdmin();
                } else {
                    initUserDashboard(googleName);
                    if (json.status === 'new_user' || json.status === 'incomplete_profile') {
                        offlineTargetEmail = ''; 
                        openProfileModal(true); 
                        Swal.fire({ toast: true, position: 'top-end', icon: 'info', title: 'Silakan lengkapi data diri Anda', showConfirmButton: false, timer: 3000 });
                    }
                }
            } catch (e) {
                Swal.fire('Error', 'Gagal koneksi server.', 'error').then(() => {
                    localStorage.clear(); location.reload();
                });
            }
        }

        function initUserDashboard(name) {
            document.getElementById('user-dashboard').classList.remove('hidden');
            document.getElementById('admin-dashboard').classList.add('hidden');
            document.getElementById('app-container').classList.remove('admin-mode');
            const dispName = userProfile ? userProfile.nama : name;
            const dispUnit = userProfile ? userProfile.unit : 'Lengkapi Profil Anda';
            document.getElementById('display-name').textContent = dispName;
            document.getElementById('display-unit').textContent = dispUnit;
            document.getElementById('avatar-initials').textContent = dispName.charAt(0).toUpperCase();
            fetchHistory();
        }

        function handleLogout() { localStorage.clear(); location.reload(); }

        function openProfileModal(canClose) {
            const modal = document.getElementById('profile-modal');
            const closeBtn = document.getElementById('close-profile-btn');
            const logoutBtn = document.getElementById('logout-profile-btn');
            modal.style.display = 'flex';
            
            if (canClose) { closeBtn.style.display = 'block'; logoutBtn.style.display = 'none'; } 
            else { closeBtn.style.display = 'none'; logoutBtn.style.display = 'block'; }

            const isAdminMode = (currentUserRole !== 'USER' && offlineTargetEmail && offlineTargetEmail !== currentUserEmail);
            const dataToShow = isAdminMode ? offlineUserProfile : userProfile;
            const targetEmail = isAdminMode ? offlineTargetEmail : currentUserEmail;

            document.getElementById('prof-target-email').value = targetEmail;
            document.getElementById('prof-status').value = '';
            toggleUnitInput(); 

            if (dataToShow) {
                document.getElementById('prof-nama').value = dataToShow.nama || '';
                document.getElementById('prof-hp').value = dataToShow.hp || '';
                
                if(dataToShow.statusPegawai) {
                    document.getElementById('prof-status').value = dataToShow.statusPegawai;
                    toggleUnitInput(); 
                    if(dataToShow.statusPegawai === 'Karyawan RSUD') {
                        const dropdown = document.getElementById('prof-unit-rsud');
                        let found = false;
                        for (let i = 0; i < dropdown.options.length; i++) {
                            if (dropdown.options[i].value === dataToShow.unit) {
                                dropdown.value = dataToShow.unit; found = true; break;
                            }
                        }
                        if (!found) {
                            dropdown.value = 'LAINNYA'; toggleRSUDUnit();
                            document.getElementById('prof-unit-rsud-manual').value = dataToShow.unit;
                        } else { toggleRSUDUnit(); }
                    } else {
                        document.getElementById('prof-instansi-luar').value = dataToShow.unit || '';
                        if(dataToShow.tglSelesai) {
                            const d = new Date(dataToShow.tglSelesai);
                            if(!isNaN(d.getTime())) document.getElementById('prof-tgl-selesai').value = d.toISOString().split('T')[0];
                        }
                    }
                }
                if (dataToShow.linkKtp) {
                    document.getElementById('ktp-status').style.display = 'block';
                    document.getElementById('prof-file').required = false;
                }
            } else {
                document.getElementById('profileForm').reset();
                document.getElementById('prof-file').required = true;
            }
        }

        function closeProfileModal() { document.getElementById('profile-modal').style.display = 'none'; }
        
        function toggleUnitInput() {
            const status = document.getElementById('prof-status').value;
            const rsudContainer = document.getElementById('prof-rsud-container');
            const luarContainer = document.getElementById('prof-pihak-ketiga-container');
            if(status === 'Karyawan RSUD') { rsudContainer.classList.remove('hidden'); luarContainer.classList.add('hidden'); } 
            else if(status === 'Pihak Ketiga') { rsudContainer.classList.add('hidden'); luarContainer.classList.remove('hidden'); } 
            else { rsudContainer.classList.add('hidden'); luarContainer.classList.add('hidden'); }
        }

        function toggleRSUDUnit() {
            const val = document.getElementById('prof-unit-rsud').value;
            const manualDiv = document.getElementById('prof-unit-rsud-manual-container');
            if(val === 'LAINNYA') manualDiv.classList.remove('hidden');
            else manualDiv.classList.add('hidden');
        }

        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const targetEmail = document.getElementById('prof-target-email').value || currentUserEmail;
            const fileInput = document.getElementById('prof-file');
            const currentContextProfile = (targetEmail === currentUserEmail) ? userProfile : offlineUserProfile;
            
            if (!currentContextProfile && fileInput.files.length === 0) {
                Swal.fire('Wajib Upload', 'Silakan upload foto KTP/SIM.', 'warning'); return;
            }

            const statusPeg = document.getElementById('prof-status').value;
            let finalUnit = ''; let tglSelesai = '';

            if (statusPeg === 'Karyawan RSUD') {
                const dropVal = document.getElementById('prof-unit-rsud').value;
                if(dropVal === 'LAINNYA') finalUnit = document.getElementById('prof-unit-rsud-manual').value;
                else finalUnit = dropVal;
            } else {
                finalUnit = document.getElementById('prof-instansi-luar').value;
                tglSelesai = document.getElementById('prof-tgl-selesai').value;
            }

            if(!finalUnit) { Swal.fire('Data Tidak Lengkap', 'Mohon isi nama Unit / Instansi.', 'warning'); return; }

            Swal.fire({ title: 'Menyimpan Profil...', didOpen: () => Swal.showLoading() });
            
            const payload = {
                email: targetEmail, nama: document.getElementById('prof-nama').value,
                statusPegawai: statusPeg, unit: finalUnit, tglSelesai: tglSelesai, 
                hp: document.getElementById('prof-hp').value, existingKtp: currentContextProfile ? currentContextProfile.linkKtp : ''
            };

            if (fileInput.files.length > 0) { payload.fileKtp = await compressImage(fileInput.files[0]); }

            try {
                const res = await fetch(`${WEB_APP_URL}?action=saveProfile`, { method: 'POST', body: JSON.stringify(payload) });
                const json = await res.json();
                
                if (json.status === 'success') {
                    const updatedProfile = { ...payload, linkKtp: json.linkKtp };
                    delete updatedProfile.fileKtp;

                    if (targetEmail === currentUserEmail) {
                        userProfile = updatedProfile;
                        if(currentUserRole === 'USER') initUserDashboard(userProfile.nama);
                    } else { offlineUserProfile = updatedProfile; }
                    
                    Swal.fire('Berhasil', 'Profil disimpan.', 'success');
                    closeProfileModal();

                    if (currentUserRole !== 'USER') {
                        // Jika Admin sedang edit user, refresh list user
                        if(document.getElementById('tab-users').classList.contains('active')) {
                            fetchUsers();
                        } else if (offlineTargetEmail && offlineTargetEmail !== currentUserEmail) { 
                            openSubmissionModal(); 
                        }
                    }

                } else { throw new Error(json.message); }
            } catch (err) { Swal.fire('Gagal', err.message, 'error'); }
        });

        function openSubmissionModal() {
            const isOfflineMode = (currentUserRole !== 'USER' && offlineTargetEmail && offlineTargetEmail !== currentUserEmail);
            const targetProf = isOfflineMode ? offlineUserProfile : userProfile;
            const targetEmail = isOfflineMode ? offlineTargetEmail : currentUserEmail;

            if (!targetEmail) { Swal.fire('Error', 'Gagal mendeteksi email. Refresh halaman.', 'error'); return; }

            if (!targetProf || !targetProf.nama || !targetProf.hp || !targetProf.linkKtp || !targetProf.unit) {
                Swal.fire({ title: 'Profil Belum Lengkap', text: 'Lengkapi data profil sebelum mengajukan.', icon: 'warning', confirmButtonText: 'Lengkapi Sekarang' }).then((result) => {
                    if(result.isConfirmed) openProfileModal(true);
                }); return;
            }

            document.getElementById('sub-target-email-hidden').value = targetEmail;
            document.getElementById('submission-modal').style.display = 'flex';
            
            const notice = document.getElementById('sub-admin-notice');
            if (isOfflineMode) {
                notice.style.display = 'block';
                document.getElementById('sub-target-user').textContent = `${targetProf.nama} (${offlineTargetEmail})`;
            } else { notice.style.display = 'none'; }
        }

        function closeSubmissionModal() {
            document.getElementById('submission-modal').style.display = 'none';
            if (currentUserRole !== 'USER') { offlineTargetEmail = ''; offlineUserProfile = null; }
        }

        function toggleSubFields() {
            const val = document.getElementById('sub-tujuan').value;
            const newSec = document.getElementById('sub-kendaraan-baru');
            const oldSec = document.getElementById('sub-kendaraan-lama');
            const oldLabel = document.getElementById('lbl-nopol-lama');

            newSec.classList.add('hidden'); oldSec.classList.add('hidden');
            if (val === 'Pendaftaran Baru' || val === 'Rubah Nomor Kendaraan') newSec.classList.remove('hidden');
            if (val === 'Rubah Nomor Kendaraan') { oldSec.classList.remove('hidden'); oldLabel.innerText = "Nomor Polisi Lama"; } 
            else if (val === 'Hapus Nomor Kendaraan') { oldSec.classList.remove('hidden'); oldLabel.innerText = "Nomor Polisi yang akan Dihapus"; }
        }

        document.getElementById('submissionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const finalTargetEmail = document.getElementById('sub-target-email-hidden').value;
            if(!finalTargetEmail) { Swal.fire('Error', 'Target email hilang. Refresh.', 'error'); return; }

            Swal.fire({ title: 'Mengirim...', didOpen: () => Swal.showLoading() });
            
            const payload = {
                emailAkunGoogle: finalTargetEmail, submitterEmail: currentUserEmail,
                jenisPengajuan: document.getElementById('sub-tujuan').value, jenisKendaraanBaru: document.getElementById('sub-jenis').value,
                noPolisiBaru: document.getElementById('sub-nopol-baru').value, noPolisiLama: document.getElementById('sub-nopol-lama').value,
                keteranganLainnya: document.getElementById('sub-ket').value
            };
            try {
                const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) });
                const json = await res.json();
                if (json.status === 'success') {
                    Swal.fire('Terkirim!', 'Pengajuan berhasil diproses.', 'success');
                    closeSubmissionModal(); this.reset();
                    if(currentUserRole === 'USER') fetchHistory();
                    if(currentUserRole !== 'USER') fetchSubmissions(1);
                } else { throw new Error(json.message); }
            } catch (err) { Swal.fire('Gagal', err.message, 'error'); }
        });

        async function fetchHistory() {
            const container = document.getElementById('vehicle-list');
            const loading = document.getElementById('loading-vehicles');
            const empty = document.getElementById('empty-state');
            container.innerHTML = ''; loading.style.display = 'block'; empty.classList.add('hidden');
            try {
                const res = await fetch(`${WEB_APP_URL}?action=getUserHistory&email=${encodeURIComponent(currentUserEmail)}`);
                const json = await res.json();
                loading.style.display = 'none';
                if (json.data && json.data.length > 0) {
                    json.data.forEach(v => {
                        let badgeColor = '#fff9db'; let textColor = '#f08c00';
                        if(v.status === 'Selesai') { badgeColor = '#e6fcf5'; textColor = '#087f5b'; }
                        if(v.status === 'Ditolak') { badgeColor = '#fff5f5'; textColor = '#c92a2a'; }
                        const html = `<div class="vehicle-card"><span class="v-status" style="background:${badgeColor}; color:${textColor}">${v.status}</span><span class="v-nopol">${v.nopol}</span><span class="v-info">${v.jenis}</span><span class="v-info" style="font-size:0.8em; margin-top:5px; color:#aaa;">${v.tanggal}</span></div>`;
                        container.innerHTML += html;
                    });
                } else { empty.classList.remove('hidden'); }
            } catch(e) { loading.style.display = 'none'; }
        }

        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = e => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                        const scale = 800 / img.width; canvas.width = 800; canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve({ base64: canvas.toDataURL('image/jpeg', 0.7).split(',')[1], type: 'image/jpeg' });
                    }
                }
            });
        }

        function openAdminOfflineInput() {
            document.getElementById('admin-input-modal').style.display = 'flex';
            document.getElementById('offline-email-input').value = '';
            offlineTargetEmail = ''; offlineUserProfile = null;
        }

        async function checkOfflineUser() {
            const email = document.getElementById('offline-email-input').value.trim().toLowerCase();
            if(!email) return Swal.fire('Error', 'Masukkan email', 'warning');
            Swal.fire({ title: 'Mengecek User...', didOpen: () => Swal.showLoading() });
            try {
                const res = await fetch(`${WEB_APP_URL}?action=checkUser&email=${encodeURIComponent(email)}&name=OfflineUser&ip=AdminInput&device=AdminDevice`);
                const json = await res.json();
                Swal.close();
                offlineTargetEmail = email;
                document.getElementById('admin-input-modal').style.display = 'none';
                if (json.status === 'new_user' || json.status === 'incomplete_profile') {
                    offlineUserProfile = json.profile;
                    Swal.fire('Info', 'User belum lengkap. Isi profil dulu.', 'info').then(() => openProfileModal(true));
                } else {
                    offlineUserProfile = json.profile;
                    openSubmissionModal();
                }
            } catch(e) { Swal.fire('Error', 'Gagal cek user', 'error'); }
        }

        function initAdmin() {
            document.getElementById('user-dashboard').classList.add('hidden');
            document.getElementById('admin-dashboard').classList.remove('hidden');
            document.getElementById('app-container').classList.add('admin-mode');
            const badge = document.getElementById('admin-role-badge');
            badge.textContent = currentUserRole;
            badge.className = `role-badge ${currentUserRole === 'SUPERADMIN' ? 'role-super' : 'role-admin'}`;
            
            // Show/Hide Add User Button based on role (Superadmin only or both? Request said Superadmin, assuming both admins can manage but superadmin has priority)
            if(currentUserRole === 'SUPERADMIN') {
                 document.getElementById('btn-add-user-admin').classList.remove('hidden');
            }

            const lastTab = localStorage.getItem('lastAdminTab') || 'submissions';
            switchTab(lastTab);
            loadFormStatus();
        }

        async function loadFormStatus() {
            try {
                const res = await fetch(`${WEB_APP_URL}?action=getSettings`);
                const json = await res.json();
                if(json.status === 'success') {
                    currentFormStatus = json.data.formStatus;
                    updateStatusButton();
                }
            } catch(e) {}
        }

        function updateStatusButton() {
            const btn = document.getElementById('btn-toggle-status');
            if(currentFormStatus === 'ON') { btn.className = 'btn-small btn-status-on'; btn.innerHTML = '<i class="fas fa-toggle-on"></i> Formulir: BUKA'; } 
            else { btn.className = 'btn-small btn-status-off'; btn.innerHTML = '<i class="fas fa-toggle-off"></i> Formulir: TUTUP'; }
        }

        async function toggleFormStatus() {
            const newStatus = currentFormStatus === 'ON' ? 'OFF' : 'ON';
            const action = newStatus === 'ON' ? 'Membuka' : 'Menutup';
            const confirm = await Swal.fire({ title: `Formulir ${newStatus === 'ON' ? 'Dibuka' : 'Ditutup'}?`, text: `Anda akan ${action.toLowerCase()} akses formulir.`, icon: 'question', showCancelButton: true });
            if(confirm.isConfirmed) {
                Swal.showLoading();
                const res = await fetch(`${WEB_APP_URL}?action=updateSettings&formStatus=${newStatus}`);
                const json = await res.json();
                Swal.close();
                if(json.status === 'success') {
                    currentFormStatus = newStatus; updateStatusButton();
                    Swal.fire('Berhasil', `Formulir sekarang ${newStatus === 'ON' ? 'DIBUKA' : 'DITUTUP'}`, 'success');
                } else { Swal.fire('Gagal', 'Update status gagal', 'error'); }
            }
        }

        function switchTab(t) {
            document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${t}`).classList.add('active');
            if(t === 'submissions') document.getElementById('btn-tab-submissions').classList.add('active');
            if(t === 'users') document.getElementById('btn-tab-users').classList.add('active');
            localStorage.setItem('lastAdminTab', t);
            if(t==='users') fetchUsers();
            if(t==='submissions') fetchSubmissions(1);
        }

        function toggleDetails() {
            showDetailsMode = !showDetailsMode;
            const table = document.getElementById('submissions-table');
            const btn = document.getElementById('btn-detail-toggle');
            if (showDetailsMode) {
                table.classList.add('table-detailed');
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-eye-slash"></i> Tutup';
            } else {
                table.classList.remove('table-detailed');
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fas fa-eye"></i> Detail';
            }
        }

        function formatWA(n) {
            if(!n) return '';
            let c = n.toString().replace(/[^\d]/g,'');
            if(c.startsWith('0')) c = '62'+c.substring(1);
            return c;
        }

        async function fetchSubmissions(p) {
            const search = document.getElementById('search-input').value;
            const status = document.getElementById('status-filter').value;
            const res = await fetch(`${WEB_APP_URL}?action=getSubmissions&page=${p}&searchTerm=${encodeURIComponent(search)}&statusFilter=${encodeURIComponent(status)}&sortColumn=${currentSortCol}&sortDirection=${currentSortDir}`);
            const json = await res.json();
            const tbody = document.querySelector('#submissions-table tbody');
            const thead = document.querySelector('#submissions-table thead');
            tbody.innerHTML = '';
            
            const columnsToHide = ['Email Akun Google', 'Status Kepegawaian', 'Jenis Kendaraan Baru', 'Jenis Kendaraan Lama'];

            let headerHtml = '<tr>';
            json.data.headers.forEach(h => {
                let sortClass = 'sortable'; let sortIcon = '<i class="fas fa-sort sort-icon"></i>';
                if (h === currentSortCol) {
                    sortClass += currentSortDir === 'asc' ? ' asc' : ' desc';
                    sortIcon = currentSortDir === 'asc' ? '<i class="fas fa-sort-up sort-icon"></i>' : '<i class="fas fa-sort-down sort-icon"></i>';
                }
                let extraClass = columnsToHide.includes(h) ? ' optional-col' : '';
                headerHtml += `<th class="${sortClass}${extraClass}" onclick="handleSort('${h}')">${h} ${sortIcon}</th>`;
            });
            headerHtml += '</tr>';
            thead.innerHTML = headerHtml;
            
            const h = json.data.headers;
            
            json.data.pageData.forEach(r => {
                const rowData = r.rowData;
                const statusIdx = h.indexOf('Status');
                const statusVal = rowData[statusIdx];
                
                let rowClass = 'row-pending';
                if (statusVal === 'Selesai') rowClass = 'row-approved';
                if (statusVal === 'Ditolak') rowClass = 'row-rejected';
                
                const tr = document.createElement('tr');
                tr.className = rowClass;
                
                const regId = rowData[h.indexOf('Nomor Registrasi')] || '-';
                const nama = rowData[h.indexOf('Nama Lengkap')] || '-';
                const hp = rowData[h.indexOf('Telepon')] || '';
                const email = rowData[h.indexOf('Email Akun Google')] || '-';
                const unit = rowData[h.indexOf('Unit Kerja')] || rowData[h.indexOf('Afiliasi Pihak Ketiga')] || '-';
                const tujuan = rowData[h.indexOf('Jenis Pengajuan')] || '-';
                const nopol = rowData[h.indexOf('Nomor Polisi Baru')] || rowData[h.indexOf('Nomor Polisi Lama')] || '-';
                
                let footer = "Pengajuan Anda sedang kami proses.";
                if(statusVal === 'Selesai') footer = "Data anda telah terdaftar dalam sistem parkir RSUD dr. R. Koesma.";
                if(statusVal === 'Ditolak') footer = "Mohon maaf, pengajuan Anda belum dapat kami setujui.";

                let waText = ` [SIPARKIR KOESMA] Status Update\nReg ID: ${regId}\nNama: ${nama}\nStatus: ${statusVal.toUpperCase()}\n${footer}`;

                const cleanHP = formatWA(hp);
                const waLink = cleanHP ? `https://wa.me/${cleanHP}?text=${encodeURIComponent(waText)}` : '#';
                
                const rowHtml = rowData.map((c, i) => {
                    const headerName = json.data.headers[i];
                    let cellClass = columnsToHide.includes(headerName) ? 'class="optional-col"' : '';

                    if (headerName === 'Telepon') {
                        return cleanHP ? `<td ${cellClass}><a href="${waLink}" target="_blank" class="phone-link">${c}</a></td>` : `<td ${cellClass}>${c}</td>`;
                    }
                    if(headerName === 'Status') {
                        return `<td ${cellClass}>
                                    <div class="status-cell-content">
                                        <select class="status-select" onchange="updateSubStatus(this.value, ${r.originalIndex}, this)">
                                            <option value="Belum diproses" ${c==='Belum diproses'?'selected':''}>Belum diproses</option>
                                            <option value="Selesai" ${c==='Selesai'?'selected':''}>Disetujui</option>
                                            <option value="Ditolak" ${c==='Ditolak'?'selected':''}>Ditolak</option>
                                            <option value="Hapus">Hapus</option>
                                        </select>
                                    </div>
                                </td>`;
                    }
                    if(String(c).includes('http')) return `<td ${cellClass}><a href="${c}" target="_blank">Lihat</a></td>`;
                    return `<td ${cellClass}>${c}</td>`;
                }).join('');
                tr.innerHTML = rowHtml; tbody.appendChild(tr);
            });
            
            const table = document.getElementById('submissions-table');
            if (showDetailsMode) table.classList.add('table-detailed');
            else table.classList.remove('table-detailed');

            renderPagination(json.data.currentPage, json.data.totalPages);
        }

        function handleSort(colName) {
            if (currentSortCol === colName) { currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc'; } 
            else { currentSortCol = colName; currentSortDir = 'asc'; }
            fetchSubmissions(1);
        }
        function clearSearch() { document.getElementById('search-input').value = ''; fetchSubmissions(1); }
        function renderPagination(curr, total) {
            const div = document.getElementById('pagination-controls');
            if (total <= 1) { div.innerHTML = ''; return; }
            div.innerHTML = `<button onclick="fetchSubmissions(${curr-1})" ${curr===1?'disabled':''}>Prev</button> <span style="margin:0 10px;">Halaman ${curr} dari ${total}</span> <button onclick="fetchSubmissions(${curr+1})" ${curr===total?'disabled':''}>Next</button>`;
        }
        async function updateSubStatus(st, idx, selectEl) {
            let reason = '';
            if (st === 'Ditolak') {
                const { value: text, isConfirmed } = await Swal.fire({ input: 'textarea', title: 'Alasan Penolakan', text: 'Wajib diisi untuk notifikasi user', showCancelButton: true });
                if (!isConfirmed || !text) { fetchSubmissions(1); return; }
                reason = text;
            } else if (st === 'Hapus') {
                const conf = await Swal.fire({ title: 'Hapus Data?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' });
                if (!conf.isConfirmed) { fetchSubmissions(1); return; }
            }
            Swal.showLoading();
            await fetch(`${WEB_APP_URL}?action=updateStatus&rowIndex=${idx}&status=${st}&reason=${encodeURIComponent(reason)}`);
            Swal.close();
            fetchSubmissions(1);
        }
        
        async function fetchUsers() {
            const tbody = document.querySelector('#users-table tbody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Memuat...</td></tr>';
            try {
                const res = await fetch(`${WEB_APP_URL}?action=getUsersList`);
                const json = await res.json();
                tbody.innerHTML = '';
                allUsersData = json.data; // Simpan untuk edit

                json.data.forEach((u, index) => {
                    // Data Structure from GS: 
                    // [Email, Nama, Role, Status, TS, StatusPeg, Unit, HP, KTP, TglSelesai]
                    const email = u[0]; 
                    const name = u[1]; 
                    const role = u[2]; 
                    const status = u[3];
                    const hp = u[7] || '';
                    
                    const cleanHP = formatWA(hp);
                    const waLink = cleanHP ? `https://wa.me/${cleanHP}` : '#';
                    const hpCell = cleanHP ? `<a href="${waLink}" target="_blank" class="phone-link">${hp}</a>` : hp;

                    const isSuper = role === 'SUPERADMIN'; const isBlocked = status === 'BLOCKED';
                    let actions = '';
                    
                    if (currentUserRole === 'SUPERADMIN') {
                        // Tombol Edit
                        actions += `<button class="btn-action btn-edit" onclick="openEditUser('${email}')"><i class="fas fa-edit"></i></button>`;

                        if (!isSuper) {
                             if (role === 'USER') actions += `<button class="btn-action btn-promote" onclick="changeRole('${email}', 'ADMIN')">Admin</button>`;
                             if (role === 'ADMIN') actions += `<button class="btn-action btn-demote" onclick="changeRole('${email}', 'USER')">User</button>`;
                        }
                    }
                    if (!isSuper) {
                         actions += `<button class="btn-action ${isBlocked ? 'btn-unblock' : 'btn-block'}" onclick="toggleBlock('${email}', '${status}')">${isBlocked ? 'Aktifkan' : 'Blokir'}</button>`;
                    }
                    const roleClass = role === 'SUPERADMIN' ? 'role-super' : (role === 'ADMIN' ? 'role-admin' : 'role-user');
                    
                    tbody.innerHTML += `<tr>
                        <td data-label="Email">${email}</td>
                        <td data-label="Nama">${name}</td>
                        <td data-label="No. HP">${hpCell || '-'}</td>
                        <td data-label="Role"><span class="role-badge ${roleClass}">${role}</span></td>
                        <td data-label="Status"><span class="status-badge ${isBlocked?'st-blocked':'st-active'}">${status}</span></td>
                        <td data-label="Aksi">${actions || '-'}</td>
                    </tr>`;
                });
            } catch(e) { 
                console.error(e);
                tbody.innerHTML = '<tr><td colspan=\"6\" style=\"color:red; text-align:center;\">Gagal memuat data user.</td></tr>'; 
            }
        }

        function openEditUser(targetEmail) {
            // Cari data user dari allUsersData
            const user = allUsersData.find(u => u[0] === targetEmail);
            if (!user) return Swal.fire('Error', 'Data user tidak ditemukan', 'error');

            // Set global variable agar modal tahu kita sedang edit orang lain
            offlineTargetEmail = targetEmail; 
            
            // Format data agar sesuai struktur userProfile object
            offlineUserProfile = {
                nama: user[1],
                role: user[2],
                statusPegawai: user[5],
                unit: user[6],
                hp: user[7],
                linkKtp: user[8],
                tglSelesai: user[9]
            };

            // Buka Modal
            openProfileModal(true);
        }

        async function openAddUserModal() {
            const { value: email } = await Swal.fire({
                title: 'Tambah User Baru',
                input: 'email',
                inputLabel: 'Masukkan Email User',
                inputPlaceholder: 'user@gmail.com',
                showCancelButton: true
            });

            if (email) {
                Swal.fire({ title: 'Menambahkan...', didOpen: () => Swal.showLoading() });
                try {
                    const res = await fetch(`${WEB_APP_URL}?action=adminAddUser`, {
                        method: 'POST',
                        body: JSON.stringify({ email: email })
                    });
                    const json = await res.json();
                    
                    if(json.status === 'success') {
                        Swal.fire('Berhasil', 'User ditambahkan. Silakan lengkapi profilnya.', 'success').then(() => {
                            // Refresh table dan langsung buka edit modal
                            fetchUsers().then(() => openEditUser(email));
                        });
                    } else {
                        Swal.fire('Gagal', json.message, 'error');
                    }
                } catch(e) {
                    Swal.fire('Error', 'Koneksi gagal', 'error');
                }
            }
        }

        async function changeRole(email, newRole) {
            const confirm = await Swal.fire({ title: 'Ubah Role?', text: `Ubah ${email} menjadi ${newRole}?`, icon: 'question', showCancelButton: true });
            if (confirm.isConfirmed) {
                Swal.showLoading();
                const res = await fetch(`${WEB_APP_URL}?action=toggleUserRole&email=${email}&setRole=${newRole}`);
                const json = await res.json();
                Swal.close();
                if (json.status === 'success') { Swal.fire('Berhasil', 'Role diubah', 'success'); fetchUsers(); }
                else { Swal.fire('Gagal', json.message, 'error'); }
            }
        }
        async function toggleBlock(email, curr) {
            const res = await Swal.fire({ title: 'Konfirmasi', text: `Ubah status akses untuk ${email}?`, icon: 'warning', showCancelButton: true });
            if (res.isConfirmed) {
                Swal.showLoading();
                await fetch(`${WEB_APP_URL}?action=toggleUserBlock&email=${email}&status=${curr}`);
                Swal.close();
                fetchUsers();
            }
        }
    </script>
    
    <!-- SMART SENSOR MESH ANIMATION -->
    <script>
    (function() {
        const canvas = document.getElementById('sensorMeshCanvas');
        if(!canvas) return;
        
        const ctx = canvas.getContext('2d');
        let width, height;
        let dots = [];
        const spacing = 50; 
        const mouseRadius = 200; // Radius interaksi mouse lebih besar
        
        // Scan line radar
        let scanAngle = 0;
        
        // Mouse Interaction
        let mouse = { x: -999, y: -999 };
        window.addEventListener('mousemove', e => { mouse.x = e.x; mouse.y = e.y; });

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            initDots();
        }
        window.addEventListener('resize', resize);

        class Dot {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.baseAlpha = 0.2; // Lebih terang defaultnya
                this.alpha = this.baseAlpha;
                this.active = false;
                this.timer = Math.random() * 200;
            }

            update() {
                // Logic Scan Mouse (Lebih responsif)
                const dx = mouse.x - this.x;
                const dy = mouse.y - this.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                // Logic Radar Scanner
                // Bayangkan garis berputar dari tengah layar
                const cx = width / 2;
                const cy = height / 2;
                const angleToDot = Math.atan2(this.y - cy, this.x - cx);
                // Normalisasi angle
                let diffAngle = Math.abs(angleToDot - scanAngle);
                if (diffAngle > Math.PI) diffAngle = (2 * Math.PI) - diffAngle;
                
                // Jika kena scan radar
                if (diffAngle < 0.1) {
                    this.alpha = 1; // Flash terang
                }

                if (dist < mouseRadius) {
                    this.alpha = 1 - (dist / mouseRadius);
                    if(this.alpha < 0.2) this.alpha = 0.2;
                } else {
                    // Random Pulse
                    this.timer++;
                    if(this.timer > 300) { 
                        this.active = true; 
                        this.timer = 0;
                    }
                    
                    if(this.active) {
                        this.alpha += 0.05;
                        if(this.alpha >= 1) { this.active = false; }
                    } else {
                        // Fade out perlahan setelah kena radar atau pulse
                        if(this.alpha > this.baseAlpha) this.alpha -= 0.01;
                    }
                }
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, 2.5, 0, Math.PI * 2); // Titik sedikit lebih besar
                
                // Warna Neon Cyan/Emerald
                ctx.fillStyle = `rgba(0, 255, 200, ${this.alpha})`; 
                
                // Efek Glow Neon (hanya jika cukup terang agar performa aman)
                if(this.alpha > 0.4) {
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = `rgba(0, 255, 200, ${this.alpha})`;
                } else {
                    ctx.shadowBlur = 0;
                }
                
                ctx.fill();
                ctx.shadowBlur = 0; // Reset
            }
        }

        function initDots() {
            dots = [];
            for (let x = 20; x < width; x += spacing) {
                for (let y = 20; y < height; y += spacing) {
                    dots.push(new Dot(x, y));
                }
            }
        }

        function animate() {
            const loginPage = document.getElementById('login-page');
            // Cek jika login page ada dan tidak hidden. Jika hidden (user login), stop animasi.
            if(loginPage && loginPage.classList.contains('hidden')) {
                // Optional: cancelAnimationFrame di sini jika mau
                return;
            }

            ctx.clearRect(0, 0, width, height);
            
            // Putar Radar
            scanAngle += 0.02;
            if(scanAngle > Math.PI) scanAngle = -Math.PI;

            // Update & Draw Dots
            dots.forEach(dot => {
                dot.update();
                dot.draw();
            });

            // Draw Connection Lines (Grid Logic)
            ctx.lineWidth = 1; // Garis lebih tebal dikit
            for(let i=0; i<dots.length; i++) {
                let d1 = dots[i];
                // Hanya gambar garis jika titik ini sedang aktif/terang
                if(d1.alpha < 0.3) continue;

                // Optimization: Cek tetangga kanan dan bawah saja dalam grid 
                // untuk menghindari perhitungan n*n
                // Tapi array dots kita urut linear, jadi agak susah cari tetangga grid exact tanpa 2D array.
                // Fallback ke distance check untuk tetangga terdekat (simple & robust untuk resolusi layar beda2)
                
                for(let j=i+1; j<dots.length; j++) {
                    let d2 = dots[j];
                    
                    // Cek jarak kasar dulu
                    if (Math.abs(d1.x - d2.x) > spacing * 1.5 || Math.abs(d1.y - d2.y) > spacing * 1.5) continue;

                    let distSq = (d1.x-d2.x)*(d1.x-d2.x) + (d1.y-d2.y)*(d1.y-d2.y);
                    
                    // Hubungkan jika jarak <= diagonal grid
                    if(distSq <= (spacing*spacing * 2.2)) {
                        ctx.beginPath();
                        // Opacity garis tergantung seberapa terang kedua titik
                        let lineAlpha = Math.min(d1.alpha, d2.alpha) * 0.6;
                        if(lineAlpha > 0.05) {
                            ctx.strokeStyle = `rgba(0, 255, 200, ${lineAlpha})`;
                            ctx.moveTo(d1.x, d1.y);
                            ctx.lineTo(d2.x, d2.y);
                            ctx.stroke();
                        }
                    }
                }
            }
            window.meshAnimationId = requestAnimationFrame(animate);
        }

        resize();
        animate();
    })();
    </script>
</body>
</html>
