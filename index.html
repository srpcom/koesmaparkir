<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulir Layanan Parkir</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/srpcom/koesmaparkir/main/new%20logo%20rsud%202025%20kecil.png">
    <style>
        :root {
            --primary-color: #005A9C; --secondary-color: #F0F8FF; --border-color: #DCDCDC;
            --text-color: #333; --success-color: #28a745; --error-color: #dc3545;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        body {
            font-family: var(--font-family); background-image: url('https://raw.githubusercontent.com/srpcom/koesmaparkir/main/foto%20ipit.jpg');
            background-size: cover; background-position: center; background-attachment: fixed;
            color: var(--text-color); margin: 0; padding: 10px;
        }
        .container { max-width: 800px; width: 100%; margin: 20px auto; background-color: rgba(255, 255, 255, 0.4); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-radius: 12px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); }
        header { background-color: var(--primary-color); color: white; padding: 20px; text-align: center; border-bottom: 5px solid #00487a; position: sticky; top: 0; z-index: 100; transition: all 0.3s ease-in-out; }
        header .logo-image { width: 70px; height: auto; margin: 0 auto 15px auto; display: block; transition: all 0.3s ease-in-out; }
        header h1 { margin: 0; font-size: 1.5em; font-weight: 700; }
        header p { margin: 5px 0 0; opacity: 0.9; font-size: 0.9em; }
        form { padding: 20px; }
        fieldset { border: 1px solid transparent; border-radius: 8px; padding: 20px 15px; margin-bottom: 25px; }
        legend { font-weight: bold; font-size: 1.2em; color: #fff; padding: 8px 16px; border-radius: 20px; background-color: rgba(0, 90, 156, 0.7); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        input[type="text"], input[type="tel"], input[type="password"], select, textarea, input[type="file"] { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; font-size: 16px; transition: border-color 0.3s, box-shadow 0.3s; background-color: rgba(255, 255, 255, 0.8); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 90, 156, 0.2); background-color: #fff; }
        button { width: 100%; padding: 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 6px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: background-color 0.3s, transform 0.2s; }
        button:hover:not(:disabled) { background-color: #00487a; transform: translateY(-2px); }
        button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        .hidden, .hidden-section { display: none; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; color: white; flex-direction: column; padding: 15px; box-sizing: border-box; -webkit-backdrop-filter: blur(5px); backdrop-filter: blur(5px); }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-container { background-color: white; color: var(--text-color); padding: 25px; border-radius: 12px; max-width: 500px; width: 100%; box-shadow: 0 5px 25px rgba(0,0,0,0.2); }
        .modal-buttons { display: flex; gap: 15px; margin-top: 25px; }

        /* --- STYLING ADMIN PANEL --- */
        #admin-panel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .admin-box { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .admin-box h2 { text-align: center; color: var(--primary-color); margin-top: 0; }
        #admin-error { color: var(--error-color); text-align: center; margin-bottom: 15px; font-size: 0.9em; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        .dashboard-item { display: flex; justify-content: space-between; align-items: center; }
        #maintenance-status span.active { color: var(--success-color); }
        #maintenance-status span.inactive { color: var(--error-color); }

        /* --- STYLING HALAMAN MAINTENANCE --- */
        #maintenance-content {
            font-family: var(--font-family); background-color: #f8f9fa; color: #343a40;
            display: flex; justify-content: center; align-items: center; height: 100vh;
            text-align: center; padding: 20px; box-sizing: border-box;
            position: fixed; top: 0; left: 0; width: 100%; z-index: 3000;
        }
        #maintenance-content .container { background: transparent; backdrop-filter: none; border: none; box-shadow: none; }
        #maintenance-content .logo { width: 100px; margin-bottom: 30px; }
        #maintenance-content h1 { font-size: 2.5em; margin: 0; color: #005A9C; }
        #maintenance-content p { font-size: 1.2em; color: #6c757d; line-height: 1.6; }
        #maintenance-content .maintenance-icon { font-size: 5em; color: #005A9C; margin-bottom: 20px; }
    </style>
</head>
<body>
    <!-- BAGIAN UNTUK MAINTENANCE -->
    <div id="maintenance-content" class="hidden">
        <div class="container">
            <img src="https://raw.githubusercontent.com/srpcom/koesmaparkir/main/new%20logo%20rsud%202025%20kecil.png" alt="Logo RSUD" class="logo">
            <div class="maintenance-icon">&#9881;</div>
            <h1>Sedang dalam Perbaikan</h1>
            <p>
                Mohon maaf, halaman ini sedang dalam pemeliharaan untuk meningkatkan kualitas layanan.
                Kami akan segera kembali. Terima kasih atas pengertian Anda.
            </p>
        </div>
    </div>
    
    <!-- BAGIAN UNTUK FORMULIR UTAMA -->
    <div id="main-content">
        <div id="loading-overlay" class="overlay">
            <div class="spinner"></div>
            <p>Mengirim data, mohon tunggu...</p>
        </div>
        <div id="confirmation-overlay" class="overlay">
            <div class="modal-container">
                <h2>Konfirmasi Data Anda</h2>
                <p>Mohon periksa kembali data yang telah Anda isikan. screenshot jika perlu .</p>
                <div id="summary-content" class="summary-content"></div>
                <div class="modal-buttons">
                    <button type="button" id="edit-button" class="edit-button">Perbaiki Data</button>
                    <button type="button" id="final-submit-button" class="confirm-button">Ya, Kirim & Selesaikan</button>
                </div>
            </div>
        </div>
        <div id="notification-modal" class="overlay">
             <div class="modal-container">
                <p id="notification-icon" class="icon"></p>
                <h2 id="notification-title"></h2>
                <p id="notification-message"></p>
                <div class="modal-buttons"><button type="button" id="notification-close-button">Tutup</button></div>
            </div>
        </div>
        <div class="container">
             <header id="main-header">
                <img src="https://raw.githubusercontent.com/srpcom/koesmaparkir/main/new%20logo%20rsud%202025%20kecil.png" alt="Logo RSUD dr. R. Koesma" class="logo-image">
                <h1>FORMULIR LAYANAN PARKIR</h1>
                <p>RSUD dr. R. KOESMA TUBAN</p>
            </header>
            <form id="parkingForm">
                 <fieldset>
                    <legend>Tujuan Pengisian</legend>
                    <div class="form-group radio-group">
                        <label><input type="radio" name="jenisPengajuan" value="Pendaftaran Baru" onchange="toggleSections()" required> Daftar Baru</label>
                        <label><input type="radio" name="jenisPengajuan" value="Rubah Nomor Kendaraan" onchange="toggleSections()" required> Rubah Nopol</label>
                        <label><input type="radio" name="jenisPengajuan" value="Hapus Nomor Kendaraan" onchange="toggleSections()" required> Hapus Kendaraan</label>
                        <label><input type="radio" name="jenisPengajuan" value="Tambah Kendaraan Baru" onchange="toggleSections()" required> Tambah Kendaraan</label>
                        <label><input type="radio" name="jenisPengajuan" value="Penggantian Kartu" onchange="toggleSections()" required> Ganti Kartu</label>
                        <label><input type="radio" name="jenisPengajuan" value="Lainnya" onchange="toggleSections()" required> Lainnya</label>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>Informasi Karyawan</legend>
                    <div class="form-group"><label for="namaLengkap">Nama Lengkap</label><input type="text" id="namaLengkap" name="namaLengkap" required></div>
                    <div class="form-group"><label for="unitKerja">Unit / Bagian Kerja</label><select id="unitKerja" name="unitKerja" required onchange="handleUnitKerjaChange(this)"><option value="">-- Pilih Unit --</option></select></div>
                    <div class="form-group hidden" id="unitKerjaLainnya-group"><label for="unitKerjaLainnya">Silakan Tulis Nama Unit / Bagian Anda</label><input type="text" id="unitKerjaLainnya" name="unitKerjaLainnya"></div>
                    <div class="form-group"><label for="telepon">Nomor Telepon / WA (Aktif)</label><input type="tel" id="telepon" name="telepon" required></div>
                    <div class="form-group"><label for="fileKtp">Upload Identitas (KTP/SIM)</label><input type="file" id="fileKtp" name="fileKtp" accept=".jpg,.jpeg,.png,.pdf" required></div>
                </fieldset>
                <fieldset id="update-section" class="hidden-section"><legend>Data Kendaraan Lama</legend><div class="form-group radio-group"><label>Jenis Kendaraan Lama</label><br><label><input type="radio" name="jenisKendaraanLama" value="Mobil"> Mobil</label><label><input type="radio" name="jenisKendaraanLama" value="Sepeda Motor"> Sepeda Motor</label></div><div class="form-group"><label for="noPolisiLama">Nomor Polisi Lama</label><input type="text" id="noPolisiLama" name="noPolisiLama" oninput="this.value = this.value.toUpperCase().replace(/\s/g, '')" pattern="^\S+$" title="Harap isi tanpa menggunakan spasi."></div></fieldset>
                <fieldset id="card-replacement-section" class="hidden-section"><legend>Informasi Penggantian Kartu</legend><div class="form-group"><label for="alasanPenggantian">Alasan Penggantian (Contoh: Hilang, Rusak)</label><textarea id="alasanPenggantian" name="alasanPenggantian" rows="3"></textarea></div></fieldset>
                <fieldset id="new-vehicle-section" class="hidden-section"><legend>Detail Kendaraan Baru</legend><div class="form-group radio-group"><label><input type="radio" name="jenisKendaraan" value="Mobil"> Mobil</label><label><input type="radio" name="jenisKendaraan" value="Sepeda Motor"> Sepeda Motor</label></div><div class="form-group"><label for="noPolisiBaru">Nomor Polisi Baru</label><input type="text" id="noPolisiBaru" name="noPolisiBaru" oninput="this.value = this.value.toUpperCase().replace(/\s/g, '')" pattern="^\S+$" title="Harap isi tanpa menggunakan spasi."><p class="input-description">Gunakan huruf Besar, tanpa spasi. Misal: S4966EP</p></div></fieldset>
                <fieldset id="lainnya-section" class="hidden-section"><legend>Keterangan Lainnya</legend><div class="form-group"><label for="keteranganLainnya">Silakan tulis tujuan/keterangan lengkap Anda di sini</label><textarea id="keteranganLainnya" name="keteranganLainnya" rows="5"></textarea></div></fieldset>
                <fieldset id="agreement-section" class="hidden-section"><legend>Persetujuan</legend><div class="form-group checkbox-group" style="display: flex; align-items: flex-start;"><input type="checkbox" id="agreement" name="agreement" required style="margin-top:5px; margin-right:10px;"><label for="agreement">Saya menyatakan bahwa seluruh data yang saya isikan adalah benar dan saya bersedia mematuhi semua peraturan parkir yang berlaku di lingkungan RSUD.</label></div></fieldset>
                <button type="submit" id="submit-button">Kirim Formulir</button>
            </form>
        </div>
    </div>

    <!-- BAGIAN UNTUK ADMIN PANEL -->
    <div id="admin-panel" class="hidden">
        <div id="admin-login" class="admin-box">
            <h2>Login Administrator</h2>
            <p id="admin-error" class="hidden"></p>
            <div class="form-group">
                <label for="admin-password">Password</label>
                <input type="password" id="admin-password" placeholder="Masukkan password admin">
            </div>
            <button id="admin-login-button">Login</button>
        </div>
        <div id="admin-dashboard" class="admin-box hidden">
            <h2>Dasbor Admin</h2>
            <div class="dashboard-item">
                <div>
                    <p style="margin: 0; font-weight: 600;">Mode Maintenance</p>
                    <p id="maintenance-status" style="margin: 5px 0 0; font-weight: bold;">Status: </p>
                </div>
                <label class="switch">
                    <input type="checkbox" id="maintenance-toggle">
                    <span class="slider"></span>
                </label>
            </div>
             <p style="font-size: 0.8em; color: #666; margin-top: 20px;">Jika diaktifkan, pengunjung akan melihat halaman "Under Maintenance" dan tidak dapat mengakses formulir.</p>
             <button id="admin-logout-button" style="background-color: #6c757d; margin-top: 15px;">Logout</button>
        </div>
    </div>

    <script>
        // Variabel ini diisi oleh backend Google Apps Script
        const isMaintenanceOn = <?!= maintenanceMode ?>;

        // --- ELEMEN DOM UTAMA ---
        const mainContent = document.getElementById('main-content');
        const maintenanceContent = document.getElementById('maintenance-content');
        const adminPanel = document.getElementById('admin-panel');

        // --- LOGIKA TAMPILAN AWAL ---
        window.addEventListener('load', () => {
            if (window.location.hash === '#admin') {
                mainContent.classList.add('hidden');
                maintenanceContent.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                adminPanel.style.display = 'flex';
            } else if (isMaintenanceOn) {
                mainContent.classList.add('hidden');
                maintenanceContent.classList.remove('hidden');
                adminPanel.classList.add('hidden');
            } else {
                mainContent.classList.remove('hidden');
                maintenanceContent.classList.add('hidden');
                adminPanel.classList.add('hidden');
                initializeForm(); // Jalankan setup form hanya jika tidak maintenance
            }
        });

        // --- LOGIKA FORMULIR ---
        const webAppUrl = 'https://script.google.com/macros/s/AKfycbyyGFR-VxH8DWoTu7PlPjDCkp7d-QkmrC6vzxlU36WfWOxZgOKUItV0SppH0OcoCB4/exec';
        let formDataObject = {};

        function initializeForm() {
            const allSections = {
                update: document.getElementById('update-section'),
                cardReplacement: document.getElementById('card-replacement-section'),
                newVehicle: document.getElementById('new-vehicle-section'),
                lainnya: document.getElementById('lainnya-section'),
                agreement: document.getElementById('agreement-section')
            };
            const loadingOverlay = document.getElementById('loading-overlay');
            const confirmationOverlay = document.getElementById('confirmation-overlay');
            const notificationModal = document.getElementById('notification-modal');
            
            // Isi pilihan Unit Kerja
            const unitKerjaOptions = ["INSTALASI FARMASI", "INSTALASI RADIOLOGI", "INSTALASI BEDAH SENTRAL", "INSTALASI GAWAT DARURAT", "ICU", "ICCU", "HCU", "INSTALASI LABORATORIUM", "INSTALASI HEMODIALISA", "INSTALASI GIZI", "INSTALASI REKAM MEDIK", "INSTALASI PEMELIHARAAN SARANA", "INSTALASI PENYEHATAN LINGKUNGAN", "INSTALASI FORENSIK DAN MEDIKOLEGAL", "INSTALASI DIAGNOSTIK DAN INTERVENSI KORDIOVASKULER", "INSTALASI MATERNAL DAN PERINATAL", "INSTALASI REHABILITASI MEDIK", "INSTALASI SIM RS", "INSTALASI PKRS", "POLI KIR", "POLI EKSKUTIF", "POLI TMS", "POLI EEG", "POLI ENDOSKOPI", "POLI ESWL", "RUANG MAWAR/ASTER", "RUANG ANYELIR/MELATI", "RUANG ANGGREK/DAHLIA", "RUANG BOUGENVILLE", "RUANG PAVILIUN", "RUANG ISOLASI", "RUANG PERINATOLOGI", "POLI ANAK", "POLI PENYAKIT DALAM", "POLI BEDAH", "POLI MATA", "POLI THT", "POLI SYARAF", "POLI JANTUNG", "POLI PARU", "POLI GIGI", "POLI KULIT DAN KELAMIN", "POLI JIWA", "POLI TB", "POLI VCT", "POLI UMUM", "BAGIAN PROGPEL", "BAGIAN KEUANGAN", "BAGIAN ADMINISTRASI DAN UMUM DAN SDM", "BIDANG PELAYANAN MEDIK", "BIDANG KEPERAWATAN", "BIDANG PELAYANAN PENUNJANG", "KOMITE MEDIK", "KOMITE KEPERAWATAN", "KOMITE PPI", "KOMITE KESEHATAN DAN KESELAMATAN KERJA", "SATUAN PEMERIKSAAN INTERNAL", "Lainnya..."];
            const unitKerjaSelect = document.getElementById('unitKerja');
            unitKerjaOptions.forEach(opt => { const option = document.createElement('option'); option.value = (opt === 'Lainnya...') ? 'Lainnya' : opt; option.textContent = opt; unitKerjaSelect.appendChild(option); });

            window.toggleSections = function() {
                const choice = document.querySelector('input[name="jenisPengajuan"]:checked').value;
                Object.values(allSections).forEach(sec => { sec.style.display = 'none'; setRequired(sec, false); });
                
                const show = (sec) => { sec.style.display = 'block'; setRequired(sec, true); };
                
                switch(choice) {
                    case 'Pendaftaran Baru':
                    case 'Tambah Kendaraan Baru': show(allSections.newVehicle); show(allSections.agreement); break;
                    case 'Rubah Nomor Kendaraan': show(allSections.update); show(allSections.newVehicle); show(allSections.agreement); break;
                    case 'Hapus Nomor Kendaraan': show(allSections.update); show(allSections.agreement); break;
                    case 'Penggantian Kartu': show(allSections.update); show(allSections.cardReplacement); show(allSections.agreement); break;
                    case 'Lainnya': show(allSections.lainnya); show(allSections.agreement); break;
                }
            };
            
            function setRequired(element, isRequired) {
                element.querySelectorAll('input, select, textarea').forEach(input => {
                    if(input.type !== 'radio' && input.type !== 'checkbox' && input.type !== 'file') {
                        input.required = (element.style.display !== 'none') ? isRequired : false;
                    }
                });
            }

            window.handleUnitKerjaChange = function(selectElement) {
                const lainnyaGroup = document.getElementById('unitKerjaLainnya-group');
                const lainnyaInput = document.getElementById('unitKerjaLainnya');
                lainnyaInput.required = (selectElement.value === 'Lainnya');
                lainnyaGroup.classList.toggle('hidden', selectElement.value !== 'Lainnya');
                if (selectElement.value !== 'Lainnya') lainnyaInput.value = '';
            };
            
            async function compressAndReadFile(file, maxSizeInBytes = 512000) { /* ... (fungsi kompresi file) ... */ }
            function populateSummary(data) { /* ... (fungsi ringkasan) ... */ }
            function showNotification(isSuccess, message) { /* ... (fungsi notifikasi) ... */ }

            document.getElementById('parkingForm').addEventListener('submit', function(e) { e.preventDefault(); /* ... (logika submit awal) ... */ });
            document.getElementById('edit-button').addEventListener('click', () => confirmationOverlay.style.display = 'none');
            document.getElementById('notification-close-button').addEventListener('click', () => { /* ... (logika tutup notifikasi) ... */ });
            document.getElementById('final-submit-button').addEventListener('click', async function() { /* ... (logika submit akhir) ... */ });
        }


        // --- LOGIKA ADMIN PANEL ---
        const adminLogin = document.getElementById('admin-login');
        const adminDashboard = document.getElementById('admin-dashboard');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminLoginButton = document.getElementById('admin-login-button');
        const adminError = document.getElementById('admin-error');
        const maintenanceToggle = document.getElementById('maintenance-toggle');
        const maintenanceStatus = document.getElementById('maintenance-status');
        const adminLogoutButton = document.getElementById('admin-logout-button');
        let adminPassword = null;

        async function callAdminBackend(action, data = {}) {
            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST', mode: 'cors', cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, ...data }),
                    redirect: 'follow'
                });
                if (!response.ok) throw new Error(`Server error: ${response.statusText}`);
                return await response.json();
            } catch (error) {
                console.error('Admin backend call failed:', error);
                return { status: 'error', message: 'Tidak dapat terhubung ke server.' };
            }
        }

        async function handleAdminLogin() {
            const password = adminPasswordInput.value;
            if (!password) { showAdminError('Password tidak boleh kosong.'); return; }
            adminLoginButton.disabled = true; adminLoginButton.textContent = 'Mengecek...';
            const result = await callAdminBackend('getMaintenanceStatus', { password });
            if (result.status === 'success') {
                adminPassword = password;
                adminLogin.classList.add('hidden');
                adminDashboard.classList.remove('hidden');
                updateDashboardUI(result.data.isEnabled);
            } else {
                showAdminError(result.message || 'Password salah.');
            }
            adminLoginButton.disabled = false; adminLoginButton.textContent = 'Login';
        }

        function handleAdminLogout() {
            adminPassword = null; adminPasswordInput.value = '';
            adminDashboard.classList.add('hidden'); adminLogin.classList.remove('hidden');
        }

        async function setMaintenanceMode(isEnabled) {
            const result = await callAdminBackend('setMaintenanceMode', { password: adminPassword, enabled: isEnabled });
            if (result.status === 'success') {
                updateDashboardUI(isEnabled);
                alert('Status maintenance berhasil diubah!');
            } else {
                alert('Gagal mengubah status: ' + (result.message || 'Error'));
                maintenanceToggle.checked = !isEnabled;
            }
        }
        
        function showAdminError(message) {
            adminError.textContent = message;
            adminError.classList.remove('hidden');
        }

        function updateDashboardUI(isEnabled) {
            maintenanceToggle.checked = isEnabled;
            maintenanceStatus.innerHTML = `Status: ${isEnabled ? '<span class="active">AKTIF</span>' : '<span class="inactive">NONAKTIF</span>'}`;
        }

        adminLoginButton.addEventListener('click', handleAdminLogin);
        adminPasswordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAdminLogin(); });
        maintenanceToggle.addEventListener('change', (e) => setMaintenanceMode(e.target.checked));
        adminLogoutButton.addEventListener('click', handleAdminLogout);
    </script>
</body>
</html>

