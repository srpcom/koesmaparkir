<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Layanan Parkir RSUD</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/srpcom/koesmaparkir/main/new%20logo%20rsud%202025%20kecil.png">
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #005A9C; --primary-dark: #00487a;
            --success-color: #28a745; --error-color: #dc3545;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --border-radius: 12px;
            --font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body { 
            font-family: var(--font-family); 
            background-image: url('https://raw.githubusercontent.com/srpcom/koesmaparkir/main/foto%20ipit.jpg'); 
            background-size: cover; background-position: center; background-attachment: fixed; 
            color: #333; margin: 0; min-height: 100vh;
            display: flex; flex-direction: column;
        }
        body::before {
            content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(4px); z-index: -1;
        }

        /* Container Default */
        .container { 
            max-width: 1000px; width: 95%; margin: 30px auto; 
            background-color: var(--glass-bg); 
            border-radius: var(--border-radius); 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
            overflow: hidden;
            transition: all 0.3s ease-in-out;
        }

        /* Container Full Screen (Admin View) */
        .container.admin-mode {
            max-width: 100%; width: 100%; margin: 0; border-radius: 0; min-height: 100vh;
            background-color: #ffffff;
        }

        header { 
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); 
            color: white; padding: 20px; text-align: center; 
            display: flex; align-items: center; justify-content: center; gap: 15px;
        }
        header img { width: 50px; }
        header div { text-align: left; }
        header h1 { margin: 0; font-size: 1.2rem; font-weight: 700; }
        header p { margin: 0; font-size: 0.8rem; opacity: 0.9; }

        /* LOGIN PAGE */
        #login-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center; z-index: 2000;
            transition: opacity 0.5s ease;
        }
        .login-card {
            background: white; padding: 40px; border-radius: 20px;
            text-align: center; box-shadow: 0 15px 50px rgba(0,0,0,0.3);
            width: 90%; max-width: 400px;
        }

        .swal2-container { z-index: 9999 !important; }

        /* DASHBOARD USER */
        .dashboard-header {
            padding: 20px; background: #fff; border-bottom: 1px solid #eee;
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 10px;
        }
        .user-profile-summary { display: flex; align-items: center; gap: 15px; }
        .user-avatar {
            width: 50px; height: 50px; background: var(--primary-color); color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.5em; font-weight: bold;
        }
        .user-info h3 { margin: 0; font-size: 1.1em; color: var(--primary-dark); }
        .user-info span { font-size: 0.85em; color: #666; }
        
        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; }
        .btn-small { padding: 8px 12px; border-radius: 20px; border: 1px solid #ddd; background: white; cursor: pointer; font-size: 0.9em; transition: 0.2s; display: flex; align-items: center; gap: 5px; }
        .btn-small:hover { background: #f0f0f0; }
        .btn-logout { color: var(--error-color); border-color: #ffdce0; background: #fff0f1; }
        .btn-edit-profile { color: var(--primary-color); border-color: #d0ebff; background: #e7f5ff; }
        
        .btn-status-on { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .btn-status-off { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }

        .dashboard-content { padding: 25px; }
        .section-title { font-size: 1.1em; font-weight: bold; margin-bottom: 15px; border-left: 4px solid var(--primary-color); padding-left: 10px; color: #444; }

        /* Vehicle Grid */
        .vehicle-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .vehicle-card {
            background: white; border: 1px solid #eee; border-radius: 10px; padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative;
        }
        .vehicle-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 5px; height: 100%;
            background: var(--primary-color); border-radius: 10px 0 0 10px;
        }
        .v-nopol { font-size: 1.4em; font-weight: 800; color: #333; display: block; }
        .v-info { font-size: 0.9em; color: #666; display: block; margin-top: 5px; }
        .v-status { 
            display: inline-block; padding: 3px 10px; border-radius: 12px; 
            font-size: 0.75em; font-weight: bold; text-transform: uppercase; float: right;
        }
        
        .btn-float-add {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            width: 100%; background: var(--primary-color); color: white;
            padding: 15px; border-radius: 10px; border: none;
            font-size: 1.1em; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,90,156, 0.3); transition: 0.2s;
        }
        .btn-float-add:hover { background: var(--primary-dark); transform: translateY(-2px); }

        /* MODAL COMMON */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2500;
            display: none; justify-content: center; align-items: flex-start;
            overflow-y: auto; padding: 20px 0; backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white; width: 95%; max-width: 600px;
            border-radius: 15px; overflow: hidden; animation: zoomIn 0.3s;
            margin: auto; position: relative;
        }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-header {
            background: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-header h3 { margin: 0; color: #333; }
        .btn-close { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #666; }
        
        form { padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9em; color: #333; }
        
        /* GENERAL INPUT STYLING */
        input, select, textarea { 
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; 
            font-size: 1em; box-sizing: border-box; background-color: #fff;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 2px rgba(0,90,156,0.1); }

        /* --- PERBAIKAN TOMBOL UPLOAD --- */
        input[type="file"] {
            padding: 8px;
            background: #f8f9fa; 
            border: 1px solid #ccc;
            cursor: pointer;
        }
        /* Style untuk tombol "Choose File" bawaan browser */
        input[type="file"]::file-selector-button {
            margin-right: 15px;
            border: none;
            background: var(--primary-color);
            padding: 10px 20px;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-weight: bold;
            transition: background .2s ease-in-out;
        }
        input[type="file"]::-webkit-file-upload-button {
            margin-right: 15px;
            border: none;
            background: var(--primary-color);
            padding: 10px 20px;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-weight: bold;
            transition: background .2s ease-in-out;
        }
        input[type="file"]::file-selector-button:hover,
        input[type="file"]::-webkit-file-upload-button:hover {
            background: var(--primary-dark);
        }
        
        /* --- PERBAIKAN TOMBOL SAVE --- */
        .btn-submit {
            width: 100%; padding: 15px; 
            background-color: var(--success-color) !important; /* Hijau Kuat */
            color: white !important;
            border: none; border-radius: 8px; 
            font-weight: bold; font-size: 1.1em; 
            cursor: pointer; margin-top: 10px;
            box-shadow: 0 4px 6px rgba(40, 167, 69, 0.2);
        }
        .btn-submit:hover {
            background-color: #218838 !important;
            transform: translateY(-1px);
        }

        /* Admin Styles */
        .admin-tabs { display: flex; background: white; border-bottom: 1px solid #ddd; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; cursor: pointer; font-weight: 600; }
        .tab-btn.active { border-bottom: 3px solid var(--primary-color); color: var(--primary-color); background: #f8f9fa; }
        .admin-panel { display: none; padding: 20px; background: white; }
        .admin-panel.active { display: block; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; margin-top: 15px; }
        th { background: #f1f3f5; padding: 10px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #eee; }

        /* ROW COLORS FOR ADMIN TABLE */
        tr.row-pending td { background-color: #fff9db !important; }
        tr.row-approved td { background-color: #e6fcf5 !important; }
        tr.row-rejected td { background-color: #fff5f5 !important; }
        
        .status-select {
            padding: 5px; border-radius: 5px; border: 1px solid #ccc; font-weight: bold;
            background: white; cursor: pointer;
        }

        /* Utils & Status */
        .hidden { display: none !important; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
        .st-active { background: #e6fcf5; color: #087f5b; }
        .st-blocked { background: #fff5f5; color: #c92a2a; }
        
        .role-badge { padding: 3px 6px; border-radius: 3px; font-size: 0.75em; text-transform: uppercase; font-weight: bold; }
        .role-super { background: #343a40; color: #fff; }
        .role-admin { background: #4dabf7; color: #fff; }
        .role-user { background: #e9ecef; color: #495057; }
        
        .btn-action { padding: 4px 8px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.8em; margin-right: 3px; }
        .btn-promote { background: #fff9db; color: #f08c00; border: 1px solid #ffe066; }
        .btn-demote { background: #e9ecef; color: #666; }
        .btn-block { background: #ffc9c9; color: #c92a2a; }
        .btn-unblock { background: #b2f2bb; color: #2b8a3e; }

        @media (max-width: 768px) {
            .container { width: 100%; margin: 0; border-radius: 0; box-shadow: none; }
            table, thead, tbody, th, td, tr { display: block; }
            thead { display: none; }
            tr { border: 1px solid #eee; margin-bottom: 10px; padding: 10px; border-radius: 8px; }
            td { display: flex; justify-content: space-between; border: none; padding: 5px 0; flex-wrap: wrap; }
            td::before { content: attr(data-label); font-weight: bold; color: #777; width: 40%; }
        }
    </style>
</head>
<body>

    <!-- LOGIN PAGE -->
    <div id="login-page">
        <div class="login-card">
            <img src="https://raw.githubusercontent.com/srpcom/koesmaparkir/main/new%20logo%20rsud%202025%20kecil.png" alt="Logo" style="width:80px; margin-bottom:15px;">
            <h2>Layanan Parkir</h2>
            <p>Silakan login untuk melanjutkan</p>
            
            <div id="g_id_onload" 
                 data-client_id="783459415718-mp0vsmd2lopajf2ut0aqc6drjrs95pu8.apps.googleusercontent.com" 
                 data-callback="handleCredentialResponse" 
                 data-auto_prompt="false">
            </div>
            <div style="display: flex; justify-content: center; margin-top: 15px;">
                <div class="g_id_signin" 
                     data-type="standard" 
                     data-size="large" 
                     data-theme="outline" 
                     data-text="sign_in_with" 
                     data-shape="pill" 
                     data-logo_alignment="left">
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="app-container" class="container hidden">
        <header>
            <img src="https://raw.githubusercontent.com/srpcom/koesmaparkir/main/new%20logo%20rsud%202025%20kecil.png" alt="Logo">
            <div>
                <h1>Layanan Parkir</h1>
                <p>RSUD dr. R. KOESMA TUBAN</p>
            </div>
        </header>

        <!-- USER DASHBOARD -->
        <div id="user-dashboard">
            <div class="dashboard-header">
                <div class="user-profile-summary">
                    <div class="user-avatar" id="avatar-initials">U</div>
                    <div class="user-info">
                        <h3 id="display-name">User Name</h3>
                        <span id="display-unit">Unit Kerja</span>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn-small btn-edit-profile" onclick="openProfileModal(true)">Edit Profil</button>
                    <button class="btn-small btn-logout" onclick="handleLogout()">Keluar</button>
                </div>
            </div>
            <div class="dashboard-content">
                <div class="section-title"><i class="fas fa-history"></i> Riwayat Pengajuan</div>
                <div id="loading-vehicles" style="text-align:center; padding:20px;">
                    <i class="fas fa-spinner fa-spin fa-2x" style="color:var(--primary-color)"></i>
                </div>
                <div id="vehicle-list" class="vehicle-grid"></div>
                <div id="empty-state" class="hidden" style="text-align:center; padding:30px; color:#999;">
                    <p>Belum ada data pengajuan.</p>
                </div>
                <button class="btn-float-add" onclick="openSubmissionModal()">
                    <i class="fas fa-plus-circle"></i> Ajukan Layanan Parkir
                </button>
            </div>
        </div>

        <!-- ADMIN DASHBOARD -->
        <div id="admin-dashboard" class="hidden">
            <div class="dashboard-header" style="background:#e3f2fd;">
                <div>
                    <h3 style="color:#00487a">Dashboard Admin</h3>
                    <span id="admin-role-badge" class="role-badge role-admin">ADMIN</span>
                </div>
                <div class="action-buttons">
                    <button id="btn-toggle-status" class="btn-small btn-status-on" onclick="toggleFormStatus()">
                        <i class="fas fa-toggle-on"></i> Formulir: Loading...
                    </button>
                    
                    <button class="btn-small btn-edit-profile" onclick="openAdminOfflineInput()">
                        <i class="fas fa-keyboard"></i> Input Offline
                    </button>
                    <button class="btn-small btn-logout" onclick="handleLogout()">Keluar</button>
                </div>
            </div>
            <div class="admin-tabs">
                <button class="tab-btn active" id="btn-tab-submissions" onclick="switchTab('submissions')">Data Pengajuan</button>
                <button class="tab-btn" id="btn-tab-users" onclick="switchTab('users')">Manajemen User</button>
            </div>
            <div id="tab-submissions" class="admin-panel active">
                <button onclick="fetchSubmissions(1)" class="btn-small">Refresh Data</button>
                <div style="overflow-x:auto;"><table id="submissions-table"><thead></thead><tbody></tbody></table></div>
            </div>
            <div id="tab-users" class="admin-panel">
                <button onclick="fetchUsers()" class="btn-small">Refresh User</button>
                <div style="overflow-x:auto;">
                    <table id="users-table">
                        <thead><tr><th>Email</th><th>Nama</th><th>Role</th><th>Status</th><th>Aksi</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PROFIL (User & Admin Input) -->
    <div id="profile-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-id-card"></i> Data User</h3>
                <div style="display:flex; gap:10px; align-items:center;">
                    <!-- Tombol Logout Khusus saat Wajib Isi Profil -->
                    <button id="logout-profile-btn" class="btn-small btn-logout hidden" onclick="handleLogout()" style="padding:5px 10px; font-size:0.8em;">
                        <i class="fas fa-sign-out-alt"></i> Keluar
                    </button>
                    <button id="close-profile-btn" class="btn-close" onclick="closeProfileModal()">&times;</button>
                </div>
            </div>
            <form id="profileForm">
                <input type="hidden" id="prof-target-email"> 
                <div class="form-group">
                    <label>Nama Lengkap (Sesuai KTP)</label>
                    <input type="text" id="prof-nama" required>
                </div>
                <div class="form-group">
                    <label>Status Kepegawaian</label>
                    <select id="prof-status" onchange="toggleUnitInput()" required>
                        <option value="">-- Pilih --</option>
                        <option value="Karyawan RSUD">Karyawan RSUD</option>
                        <option value="Pihak Ketiga">Pihak Ketiga / Lainnya</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Unit Kerja / Instansi</label>
                    <input type="text" id="prof-unit" placeholder="Nama Unit atau Perusahaan" required>
                </div>
                <div class="form-group">
                    <label>No. HP / WhatsApp</label>
                    <input type="tel" id="prof-hp" placeholder="08xxxxxxxxxx" required>
                </div>
                <div class="form-group">
                    <label>Upload Foto KTP/SIM (Sekali saja)</label>
                    <input type="file" id="prof-file" accept="image/*">
                    <small id="ktp-status" style="color:green; display:none; margin-top:5px;">
                        <i class="fas fa-check-circle"></i> Sudah ada file KTP.
                    </small>
                </div>
                <button type="submit" class="btn-submit">Simpan Profil</button>
            </form>
        </div>
    </div>

    <!-- MODAL ADMIN INPUT EMAIL -->
    <div id="admin-input-modal" class="modal-overlay">
        <div class="modal-content" style="max-width:400px;">
            <div class="modal-header">
                <h3>Input Offline</h3>
                <button class="btn-close" onclick="document.getElementById('admin-input-modal').style.display='none'">&times;</button>
            </div>
            <div style="padding:20px;">
                <p>Masukkan Email User (Pemilik Kendaraan):</p>
                <input type="email" id="offline-email-input" placeholder="user@gmail.com" style="margin-bottom:15px;">
                <button class="btn-submit" onclick="checkOfflineUser()">Cek & Lanjut</button>
            </div>
        </div>
    </div>

    <!-- MODAL PENGAJUAN -->
    <div id="submission-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-parking"></i> Ajukan Layanan</h3>
                <button class="btn-close" onclick="closeSubmissionModal()">&times;</button>
            </div>
            <div style="padding:10px 20px; background:#e8f4fc; display:none;" id="sub-admin-notice">
                <small><strong>Mode Admin:</strong> Mengajukan atas nama <span id="sub-target-user"></span></small>
            </div>
            <form id="submissionForm">
                <div class="form-group">
                    <label>Tujuan Pengajuan</label>
                    <select id="sub-tujuan" onchange="toggleSubFields()" required>
                        <option value="">-- Pilih Tujuan --</option>
                        <option value="Pendaftaran Baru">Daftar Kendaraan Baru</option>
                        <option value="Rubah Nomor Kendaraan">Ganti Plat Nomor</option>
                        <option value="Buat/Ganti Kartu Parkir">Kartu Hilang/Rusak</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                </div>
                <div id="sub-kendaraan-baru" class="hidden">
                    <div class="form-group">
                        <label>Jenis Kendaraan</label>
                        <select id="sub-jenis">
                            <option value="Motor">Motor</option>
                            <option value="Mobil">Mobil</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Nomor Polisi (Baru)</label>
                        <input type="text" id="sub-nopol-baru" style="text-transform:uppercase;" placeholder="CTH: S 1234 XX">
                    </div>
                </div>
                <div id="sub-kendaraan-lama" class="hidden form-group">
                    <label>Nomor Polisi Lama</label>
                    <input type="text" id="sub-nopol-lama" style="text-transform:uppercase;">
                </div>
                <div class="form-group">
                    <label>Keterangan Tambahan</label>
                    <textarea id="sub-ket" rows="2"></textarea>
                </div>
                <button type="submit" class="btn-submit">Kirim Pengajuan</button>
            </form>
        </div>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxGXkhavdS4mFvczIUQNxv0xEodHX28VFMYboSq6LnE7RXxQ-guNA_s7TfsE0zWlrLXTw/exec';
        const SUPERADMIN_EMAIL = 'syamsul18782@gmail.com';
        
        let userProfile = null;
        let currentUserEmail = '';
        let currentUserRole = 'USER';
        let offlineTargetEmail = ''; 
        let offlineUserProfile = null;
        let currentFormStatus = 'ON';

        // --- SESSION PERSISTENCE (AUTO LOGIN) ---
        window.addEventListener('load', () => {
            const savedEmail = localStorage.getItem('userEmail');
            const savedName = localStorage.getItem('userName');

            if (savedEmail && savedName) {
                document.getElementById('login-page').classList.add('hidden');
                currentUserEmail = savedEmail;
                checkUserBackend(savedEmail, savedName);
            }
        });

        function handleCredentialResponse(response) {
            document.getElementById('login-page').classList.add('hidden');
            const payload = JSON.parse(atob(response.credential.split('.')[1]));
            currentUserEmail = payload.email;
            
            localStorage.setItem('userEmail', payload.email);
            localStorage.setItem('userName', payload.name);
            
            checkUserBackend(payload.email, payload.name);
        }

        async function checkUserBackend(email, googleName) {
            if (!Swal.isVisible()) Swal.fire({ title: 'Memuat Profil...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            try {
                const res = await fetch(`${WEB_APP_URL}?action=checkUser&email=${encodeURIComponent(email)}&name=${encodeURIComponent(googleName)}`);
                const json = await res.json();
                Swal.close();
                
                if (json.status === 'blocked') {
                    localStorage.clear();
                    Swal.fire('Ditolak', 'Akun diblokir.', 'error').then(() => location.reload());
                    return;
                }
                
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                userProfile = json.profile;
                currentUserRole = json.role || 'USER';
                
                if (currentUserRole === 'SUPERADMIN' || currentUserRole === 'ADMIN') {
                    initAdmin();
                } else {
                    initUserDashboard(googleName);
                    if (json.status === 'new_user' || json.status === 'incomplete_profile') {
                        offlineTargetEmail = email; openProfileModal(false); 
                    }
                }
            } catch (e) {
                Swal.fire('Error', 'Gagal koneksi server.', 'error').then(() => {
                    localStorage.clear();
                    location.reload();
                });
            }
        }

        function initUserDashboard(name) {
            document.getElementById('user-dashboard').classList.remove('hidden');
            document.getElementById('admin-dashboard').classList.add('hidden');
            document.getElementById('app-container').classList.remove('admin-mode');
            const dispName = userProfile ? userProfile.nama : name;
            const dispUnit = userProfile ? userProfile.unit : 'Lengkapi Profil Anda';
            document.getElementById('display-name').textContent = dispName;
            document.getElementById('display-unit').textContent = dispUnit;
            document.getElementById('avatar-initials').textContent = dispName.charAt(0).toUpperCase();
            fetchHistory();
        }

        function handleLogout() { 
            localStorage.clear();
            location.reload(); 
        }

        function openProfileModal(canClose) {
            const modal = document.getElementById('profile-modal');
            const closeBtn = document.getElementById('close-profile-btn');
            const logoutBtn = document.getElementById('logout-profile-btn');
            
            modal.style.display = 'flex';
            
            if (canClose) {
                closeBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
            } else {
                closeBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
            }

            const dataToShow = (currentUserRole !== 'USER' && offlineTargetEmail && offlineTargetEmail !== currentUserEmail) ? offlineUserProfile : userProfile;
            const targetEmail = (currentUserRole !== 'USER' && offlineTargetEmail) ? offlineTargetEmail : currentUserEmail;
            document.getElementById('prof-target-email').value = targetEmail;
            if (dataToShow) {
                document.getElementById('prof-nama').value = dataToShow.nama || '';
                document.getElementById('prof-status').value = dataToShow.statusPegawai || '';
                document.getElementById('prof-unit').value = dataToShow.unit || '';
                document.getElementById('prof-hp').value = dataToShow.hp || '';
                if (dataToShow.linkKtp) {
                    document.getElementById('ktp-status').style.display = 'block';
                    document.getElementById('prof-file').required = false;
                }
            } else {
                document.getElementById('profileForm').reset();
                document.getElementById('prof-file').required = true;
            }
        }

        function closeProfileModal() { document.getElementById('profile-modal').style.display = 'none'; }
        function toggleUnitInput() {
            const status = document.getElementById('prof-status').value;
            const unitInput = document.getElementById('prof-unit');
            unitInput.placeholder = (status === 'Pihak Ketiga') ? "Nama Perusahaan / Instansi" : "Nama Unit / Ruangan";
        }

        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const targetEmail = document.getElementById('prof-target-email').value || currentUserEmail;
            const fileInput = document.getElementById('prof-file');
            const currentContextProfile = (targetEmail === currentUserEmail) ? userProfile : offlineUserProfile;
            if (!currentContextProfile && fileInput.files.length === 0) {
                Swal.fire('Wajib Upload', 'Silakan upload foto KTP/SIM.', 'warning');
                return;
            }
            Swal.fire({ title: 'Menyimpan Profil...', didOpen: () => Swal.showLoading() });
            const payload = {
                email: targetEmail,
                nama: document.getElementById('prof-nama').value,
                statusPegawai: document.getElementById('prof-status').value,
                unit: document.getElementById('prof-unit').value,
                hp: document.getElementById('prof-hp').value,
                existingKtp: currentContextProfile ? currentContextProfile.linkKtp : ''
            };
            if (fileInput.files.length > 0) payload.fileKtp = await compressImage(fileInput.files[0]);
            try {
                const res = await fetch(`${WEB_APP_URL}?action=saveProfile`, { method: 'POST', body: JSON.stringify(payload) });
                const json = await res.json();
                if (json.status === 'success') {
                    const updatedProfile = { ...payload, linkKtp: json.linkKtp };
                    delete updatedProfile.fileKtp;
                    if (targetEmail === currentUserEmail) {
                        userProfile = updatedProfile;
                        if(currentUserRole === 'USER') initUserDashboard(userProfile.nama);
                    } else { offlineUserProfile = updatedProfile; }
                    Swal.fire('Berhasil', 'Profil disimpan.', 'success');
                    closeProfileModal();
                    if (currentUserRole !== 'USER' && offlineTargetEmail && offlineTargetEmail !== currentUserEmail) openSubmissionModal();
                } else { throw new Error(json.message); }
            } catch (err) { Swal.fire('Gagal', err.message, 'error'); }
        });

        function openAdminOfflineInput() {
            document.getElementById('admin-input-modal').style.display = 'flex';
            document.getElementById('offline-email-input').value = '';
            offlineTargetEmail = ''; offlineUserProfile = null;
        }

        async function checkOfflineUser() {
            const email = document.getElementById('offline-email-input').value.trim().toLowerCase();
            if(!email) return Swal.fire('Error', 'Masukkan email', 'warning');
            Swal.fire({ title: 'Mengecek User...', didOpen: () => Swal.showLoading() });
            try {
                const res = await fetch(`${WEB_APP_URL}?action=checkUser&email=${encodeURIComponent(email)}&name=OfflineUser`);
                const json = await res.json();
                Swal.close();
                offlineTargetEmail = email;
                document.getElementById('admin-input-modal').style.display = 'none';
                if (json.status === 'new_user' || json.status === 'incomplete_profile') {
                    offlineUserProfile = json.profile;
                    Swal.fire('Info', 'User belum terdaftar lengkap. Silakan isi profil dulu.', 'info').then(() => openProfileModal(true));
                } else {
                    offlineUserProfile = json.profile;
                    openSubmissionModal();
                }
            } catch(e) { Swal.fire('Error', 'Gagal cek user', 'error'); }
        }

        function openSubmissionModal() {
            const isOfflineMode = (currentUserRole !== 'USER' && offlineTargetEmail && offlineTargetEmail !== currentUserEmail);
            const targetProf = isOfflineMode ? offlineUserProfile : userProfile;
            if (!targetProf) { Swal.fire('Profil Belum Lengkap', 'Lengkapi profil dulu.', 'warning'); return; }
            document.getElementById('submission-modal').style.display = 'flex';
            const notice = document.getElementById('sub-admin-notice');
            if (isOfflineMode) {
                notice.style.display = 'block';
                document.getElementById('sub-target-user').textContent = `${targetProf.nama} (${offlineTargetEmail})`;
            } else { notice.style.display = 'none'; }
        }

        function closeSubmissionModal() {
            document.getElementById('submission-modal').style.display = 'none';
            if (currentUserRole !== 'USER') { offlineTargetEmail = ''; offlineUserProfile = null; }
        }

        function toggleSubFields() {
            const val = document.getElementById('sub-tujuan').value;
            const newSec = document.getElementById('sub-kendaraan-baru');
            const oldSec = document.getElementById('sub-kendaraan-lama');
            newSec.classList.add('hidden'); oldSec.classList.add('hidden');
            if (val === 'Pendaftaran Baru' || val === 'Rubah Nomor Kendaraan') newSec.classList.remove('hidden');
            if (val === 'Rubah Nomor Kendaraan') oldSec.classList.remove('hidden');
        }

        document.getElementById('submissionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            Swal.fire({ title: 'Mengirim...', didOpen: () => Swal.showLoading() });
            const isOfflineMode = (currentUserRole !== 'USER' && offlineTargetEmail && offlineTargetEmail !== currentUserEmail);
            const targetEmail = isOfflineMode ? offlineTargetEmail : currentUserEmail;
            const payload = {
                emailAkunGoogle: targetEmail,
                submitterEmail: currentUserEmail,
                jenisPengajuan: document.getElementById('sub-tujuan').value,
                jenisKendaraanBaru: document.getElementById('sub-jenis').value,
                noPolisiBaru: document.getElementById('sub-nopol-baru').value,
                noPolisiLama: document.getElementById('sub-nopol-lama').value,
                keteranganLainnya: document.getElementById('sub-ket').value
            };
            try {
                const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) });
                const json = await res.json();
                if (json.status === 'success') {
                    Swal.fire('Terkirim!', 'Pengajuan berhasil diproses.', 'success');
                    closeSubmissionModal();
                    this.reset();
                    if(currentUserRole === 'USER') fetchHistory();
                    if(currentUserRole !== 'USER') fetchSubmissions(1);
                } else { throw new Error(json.message); }
            } catch (err) { Swal.fire('Gagal', err.message, 'error'); }
        });

        async function fetchHistory() {
            const container = document.getElementById('vehicle-list');
            const loading = document.getElementById('loading-vehicles');
            const empty = document.getElementById('empty-state');
            container.innerHTML = ''; loading.style.display = 'block'; empty.classList.add('hidden');
            try {
                const res = await fetch(`${WEB_APP_URL}?action=getUserHistory&email=${encodeURIComponent(currentUserEmail)}`);
                const json = await res.json();
                loading.style.display = 'none';
                if (json.data && json.data.length > 0) {
                    json.data.forEach(v => {
                        let badgeColor = '#fff9db'; let textColor = '#f08c00';
                        if(v.status === 'Selesai') { badgeColor = '#e6fcf5'; textColor = '#087f5b'; }
                        if(v.status === 'Ditolak') { badgeColor = '#fff5f5'; textColor = '#c92a2a'; }
                        const html = `<div class="vehicle-card"><span class="v-status" style="background:${badgeColor}; color:${textColor}">${v.status}</span><span class="v-nopol">${v.nopol}</span><span class="v-info">${v.jenis}</span><span class="v-info" style="font-size:0.8em; margin-top:5px; color:#aaa;">${v.tanggal}</span></div>`;
                        container.innerHTML += html;
                    });
                } else { empty.classList.remove('hidden'); }
            } catch(e) { loading.style.display = 'none'; }
        }

        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = e => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                        const scale = 800 / img.width; canvas.width = 800; canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve({ base64: canvas.toDataURL('image/jpeg', 0.7).split(',')[1], type: 'image/jpeg' });
                    }
                }
            });
        }

        // --- ADMIN FUNCTIONS ---
        function initAdmin() {
            document.getElementById('user-dashboard').classList.add('hidden');
            document.getElementById('admin-dashboard').classList.remove('hidden');
            document.getElementById('app-container').classList.add('admin-mode');
            const badge = document.getElementById('admin-role-badge');
            badge.textContent = currentUserRole;
            badge.className = `role-badge ${currentUserRole === 'SUPERADMIN' ? 'role-super' : 'role-admin'}`;
            
            const lastTab = localStorage.getItem('lastAdminTab') || 'submissions';
            switchTab(lastTab);
            
            loadFormStatus(); // Load Status Form
        }

        async function loadFormStatus() {
            try {
                const res = await fetch(`${WEB_APP_URL}?action=getSettings`);
                const json = await res.json();
                if(json.status === 'success') {
                    currentFormStatus = json.data.formStatus;
                    updateStatusButton();
                }
            } catch(e) {}
        }

        function updateStatusButton() {
            const btn = document.getElementById('btn-toggle-status');
            if(currentFormStatus === 'ON') {
                btn.className = 'btn-small btn-status-on';
                btn.innerHTML = '<i class="fas fa-toggle-on"></i> Formulir: BUKA';
            } else {
                btn.className = 'btn-small btn-status-off';
                btn.innerHTML = '<i class="fas fa-toggle-off"></i> Formulir: TUTUP';
            }
        }

        async function toggleFormStatus() {
            const newStatus = currentFormStatus === 'ON' ? 'OFF' : 'ON';
            const action = newStatus === 'ON' ? 'Membuka' : 'Menutup';
            const confirm = await Swal.fire({ title: `Formulir ${newStatus === 'ON' ? 'Dibuka' : 'Ditutup'}?`, text: `Anda akan ${action.toLowerCase()} akses formulir.`, icon: 'question', showCancelButton: true });
            
            if(confirm.isConfirmed) {
                Swal.showLoading();
                const res = await fetch(`${WEB_APP_URL}?action=updateSettings&formStatus=${newStatus}`);
                const json = await res.json();
                Swal.close();
                if(json.status === 'success') {
                    currentFormStatus = newStatus;
                    updateStatusButton();
                    Swal.fire('Berhasil', `Formulir sekarang ${newStatus === 'ON' ? 'DIBUKA' : 'DITUTUP'}`, 'success');
                } else { Swal.fire('Gagal', 'Update status gagal', 'error'); }
            }
        }

        function switchTab(t) {
            document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${t}`).classList.add('active');
            
            if(t === 'submissions') document.getElementById('btn-tab-submissions').classList.add('active');
            if(t === 'users') document.getElementById('btn-tab-users').classList.add('active');

            localStorage.setItem('lastAdminTab', t);

            if(t==='users') fetchUsers();
            if(t==='submissions') fetchSubmissions(1);
        }
        
        async function fetchSubmissions(p) {
            const res = await fetch(`${WEB_APP_URL}?action=getSubmissions&page=${p}`);
            const json = await res.json();
            const tbody = document.querySelector('#submissions-table tbody');
            tbody.innerHTML = '';
            document.querySelector('#submissions-table thead').innerHTML = `<tr>${json.data.headers.map(h=>`<th>${h}</th>`).join('')}</tr>`;
            json.data.pageData.forEach(r => {
                const rowData = r.rowData;
                const statusIdx = json.data.headers.indexOf('Status');
                const status = rowData[statusIdx];
                let rowClass = 'row-pending';
                if (status === 'Selesai') rowClass = 'row-approved';
                if (status === 'Ditolak') rowClass = 'row-rejected';

                const tr = document.createElement('tr');
                tr.className = rowClass;

                const rowHtml = rowData.map((c, i) => {
                    if(json.data.headers[i] === 'Status') {
                        return `<td>
                            <select class="status-select" onchange="updateSubStatus(this.value, ${r.originalIndex}, this)">
                                <option value="Belum diproses" ${c==='Belum diproses'?'selected':''}>Belum diproses</option>
                                <option value="Selesai" ${c==='Selesai'?'selected':''}>Disetujui/Selesai</option>
                                <option value="Ditolak" ${c==='Ditolak'?'selected':''}>Ditolak</option>
                                <option value="Hapus">Hapus</option>
                            </select>
                        </td>`;
                    }
                    if(String(c).includes('http')) return `<td><a href="${c}" target="_blank">Lihat</a></td>`;
                    return `<td>${c}</td>`;
                }).join('');
                tr.innerHTML = rowHtml;
                tbody.appendChild(tr);
            });
        }

        async function updateSubStatus(st, idx, selectEl) {
            let reason = '';
            if (st === 'Ditolak') {
                const { value: text, isConfirmed } = await Swal.fire({
                    input: 'textarea', title: 'Alasan Penolakan', text: 'Wajib diisi untuk notifikasi user', showCancelButton: true
                });
                if (!isConfirmed) { fetchSubmissions(1); return; }
                if (!text) { Swal.fire('Error', 'Alasan wajib diisi', 'error'); fetchSubmissions(1); return; }
                reason = text;
            } else if (st === 'Hapus') {
                const conf = await Swal.fire({ title: 'Hapus Data?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' });
                if (!conf.isConfirmed) { fetchSubmissions(1); return; }
            }
            Swal.showLoading();
            await fetch(`${WEB_APP_URL}?action=updateStatus&rowIndex=${idx}&status=${st}&reason=${encodeURIComponent(reason)}`);
            Swal.close();
            fetchSubmissions(1);
        }

        async function fetchUsers() {
            const tbody = document.querySelector('#users-table tbody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Memuat...</td></tr>';
            try {
                const res = await fetch(`${WEB_APP_URL}?action=getUsersList`);
                const json = await res.json();
                tbody.innerHTML = '';
                json.data.forEach(u => {
                    const email = u[0]; const name = u[1]; const role = u[2]; const status = u[3];
                    const isSuper = role === 'SUPERADMIN'; const isBlocked = status === 'BLOCKED';
                    let actions = '';
                    
                    if (currentUserRole === 'SUPERADMIN') {
                        if (!isSuper) {
                             if (role === 'USER') actions += `<button class="btn-action btn-promote" onclick="changeRole('${email}', 'ADMIN')">Jadikan Admin</button>`;
                             if (role === 'ADMIN') actions += `<button class="btn-action btn-demote" onclick="changeRole('${email}', 'USER')">Jadikan User</button>`;
                        }
                    }
                    if (!isSuper) {
                         actions += `<button class="btn-action ${isBlocked ? 'btn-unblock' : 'btn-block'}" onclick="toggleBlock('${email}', '${status}')">${isBlocked ? 'Aktifkan' : 'Blokir'}</button>`;
                    }
                    const roleClass = role === 'SUPERADMIN' ? 'role-super' : (role === 'ADMIN' ? 'role-admin' : 'role-user');
                    tbody.innerHTML += `<tr><td data-label="Email">${email}</td><td data-label="Nama">${name}</td><td data-label="Role"><span class="role-badge ${roleClass}">${role}</span></td><td data-label="Status"><span class="status-badge ${isBlocked?'st-blocked':'st-active'}">${status}</span></td><td data-label="Aksi">${actions || '-'}</td></tr>`;
                });
            } catch(e) { tbody.innerHTML = '<tr><td colspan="5" style="color:red">Error.</td></tr>'; }
        }

        async function changeRole(email, newRole) {
            const confirm = await Swal.fire({ title: 'Ubah Role?', text: `Ubah ${email} menjadi ${newRole}?`, icon: 'question', showCancelButton: true });
            if (confirm.isConfirmed) {
                Swal.showLoading();
                const res = await fetch(`${WEB_APP_URL}?action=toggleUserRole&email=${email}&setRole=${newRole}`);
                const json = await res.json();
                Swal.close();
                if (json.status === 'success') { Swal.fire('Berhasil', 'Role diubah', 'success'); fetchUsers(); }
                else { Swal.fire('Gagal', json.message, 'error'); }
            }
        }

        async function toggleBlock(email, curr) {
            const res = await Swal.fire({ title: 'Konfirmasi', text: `Ubah status akses untuk ${email}?`, icon: 'warning', showCancelButton: true });
            if (res.isConfirmed) {
                Swal.showLoading();
                await fetch(`${WEB_APP_URL}?action=toggleUserBlock&email=${email}&status=${curr}`);
                Swal.close();
                fetchUsers();
            }
        }
    </script>
</body>
</html>
