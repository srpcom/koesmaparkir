<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulir Layanan Parkir</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/srpcom/koesmaparkir/main/new%20logo%20rsud%202025%20kecil.png">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #005A9C; --secondary-color: #F0F8FF; --border-color: #DCDCDC;
            --text-color: #333; --success-color: #28a745; --error-color: #dc3545;
            --pending-bg: #fffbe6; --pending-color: #9c6f00; --pending-border: #ffe58f;
            --completed-bg: #f6ffed; --completed-color: #389e0d; --completed-border: #b7eb8f;
            --rejected-bg: #fff1f0; --rejected-color: #cf1322; --rejected-border: #ffa39e;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        body { font-family: var(--font-family); background-image: url('https://raw.githubusercontent.com/srpcom/koesmaparkir/main/foto%20ipit.jpg'); background-size: cover; background-position: center; background-attachment: fixed; color: var(--text-color); margin: 0; padding: 10px; transition: background-color 0.3s; }
        .container { max-width: 800px; width: 100%; margin: 20px auto; background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 12px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); }
        
        #main-form-container .container {
            background-color: rgba(255, 255, 255, 0.5); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
        }

        header { background-color: var(--primary-color); color: white; padding: 20px; text-align: center; border-bottom: 5px solid #00487a; border-radius: 12px 12px 0 0; }
        header .logo-image { width: 70px; margin: 0 auto 15px auto; display: block; }
        header h1 { margin: 0; font-size: 1.5em; }
        header p { margin: 5px 0 0; opacity: 0.9; font-size: 0.9em; }
        form, .admin-container { padding: 20px; }
        fieldset { border: 1px solid var(--border-color); border-radius: 8px; padding: 20px 15px; margin-bottom: 25px; background-color: rgba(255, 255, 255, 0.5); }
        legend { font-weight: bold; font-size: 1.2em; color: var(--primary-color); padding: 5px 15px; border-radius: 20px; background-color: #fff; border: 1px solid var(--border-color); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; }
        input[type="text"], input[type="tel"], input[type="password"], select, textarea, input[type="file"] { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; font-size: 16px; background-color: rgba(255, 255, 255, 0.9); }
        .radio-group label { display: flex; align-items: center; margin-bottom: 10px; font-weight: normal; cursor: pointer; transition: all 0.2s ease-in-out; }
        .radio-group input { margin-right: 10px; flex-shrink: 0; }
        
        .radio-group label.selected-label { font-weight: 700; color: var(--primary-color); }

        button { width: 100%; padding: 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 6px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: background-color 0.3s, transform 0.2s; }
        button:hover:not(:disabled) { background-color: #00487a; transform: translateY(-2px); }
        button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        .hidden { display: none; }

        .keterangan-box { margin-top: 15px; padding: 15px; background-color: rgba(240, 248, 255, 0.85); border-radius: 8px; border-left: 5px solid var(--primary-color); transition: all 0.3s ease-in-out; }
        .keterangan-text { margin: 0; font-size: 0.9em; color: #333; line-height: 1.5; }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; padding: 15px; box-sizing: border-box; backdrop-filter: blur(5px); }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #loading-overlay p { color: white; margin-top: 20px; font-size: 1.2em; }
        
        #summary-content p { margin: 8px 0; }
        #summary-content .summary-label { font-weight: 600; color: #555; }
        #summary-content .summary-value { color: #000; }

        .admin-section { padding: 20px; border-bottom: 1px solid #eee; }
        .admin-section h2 { margin-top: 0; color: var(--primary-color); }
        .toggle-switch { display: flex; align-items: center; gap: 10px; }
        #form-status-toggle { width: 50px; height: 26px; position: relative; cursor: pointer; }
        #form-status-toggle span { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 26px; }
        #form-status-toggle span:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        #form-status-toggle.on span { background-color: var(--success-color); }
        #form-status-toggle.on span:before { transform: translateX(24px); }
        
        #submissions-table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; font-family: 'Arial Narrow', Arial, sans-serif; }
        #submissions-table th, #submissions-table td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; font-size: 0.85em; word-break: break-word; }
        #submissions-table th { background-color: #f2f2f2; white-space: normal; vertical-align: middle; }
        #submissions-table td { white-space: normal; }

        .table-container { max-height: 500px; overflow-x: auto; }
        #logout-button { background-color: var(--error-color); margin-top: 20px; }
        .admin-controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; align-items: center; }
        #search-input, #status-filter { padding: 8px; font-size: 0.9em; border-radius: 5px; border: 1px solid #ccc; }
        #search-input { flex-grow: 1; }
        .download-button { width: auto; padding: 8px 12px; font-size: 0.9em; background-color: var(--success-color); }
        .pagination-controls { display: flex; justify-content: center; align-items: center; gap: 5px; margin-top: 15px; }
        .pagination-controls button { width: auto; padding: 5px 10px; font-size: 0.9em; }
        .pagination-controls .page-info { font-size: 0.9em; }
        #submissions-table td select { padding: 6px; border-radius: 5px; width:100%; font-weight: bold; border-width: 1px; transition: background-color 0.3s, border-color 0.3s; font-size: 1em; }
        .status-pending { background-color: var(--pending-bg); color: var(--pending-color); border-color: var(--pending-border); }
        .status-selesai { background-color: var(--completed-bg); color: var(--completed-color); border-color: var(--completed-border); }
        .status-ditolak { background-color: var(--rejected-bg); color: var(--rejected-color); border-color: var(--rejected-border); }
        
        body.admin-view { padding: 0; background-image: none; background-color: #f0f2f5; }

        @media (min-width: 769px) { #admin-dashboard .container { max-width: none; width: 100%; min-height: 100vh; margin: 0; border-radius: 0; box-shadow: none; } }
        @media (max-width: 768px) {
            body { padding: 5px; }
            .container { margin: 10px auto; padding: 0; }
            #admin-dashboard .container, #admin-login-page .container { width: 100%; margin: 5px 0; padding: 0; border: none; border-radius: 0; background-color: transparent; backdrop-filter: none; box-shadow: none; }
            #admin-dashboard .admin-container, #admin-login-page .admin-container { padding: 10px; background-color: #f9f9f9; border-radius: 8px; }
            #admin-dashboard header { border-radius: 8px 8px 0 0; }
            .table-container { overflow-x: hidden; max-height: none; }
            #submissions-table, #submissions-table thead, #submissions-table tbody, #submissions-table th, #submissions-table td, #submissions-table tr { display: block; }
            #submissions-table thead { display: none; }
            #submissions-table tr { margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
            #submissions-table td { display: flex; justify-content: space-between; align-items: center; padding: 12px; text-align: right; border: none; border-bottom: 1px solid #eee; }
            #submissions-table td:last-child { border-bottom: none; }
            #submissions-table td::before { content: attr(data-label); font-weight: bold; text-align: left; margin-right: 15px; color: var(--primary-color); flex-shrink: 0; }
            .admin-controls { flex-direction: column; align-items: stretch; }
            #submissions-table td.empty-cell { display: none; }
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="overlay"><div class="spinner"></div><p>Mohon tunggu...</p></div>

    <!-- Modal Konfirmasi Data Pengguna -->
    <div id="confirmation-modal" class="overlay">
        <div style="background: white; padding: 20px 30px; border-radius: 12px; max-width: 500px; width: 100%; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
            <h2 style="margin-top:0; color: var(--primary-color); text-align: center; border-bottom: 2px solid #eee; padding-bottom: 15px;">Konfirmasi Data Anda</h2>
            <div id="summary-content" style="text-align: left; line-height: 1.8; max-height: 60vh; overflow-y: auto; padding-right: 10px;">
                <!-- Ringkasan data akan dimasukkan di sini oleh JavaScript -->
            </div>
            <p style="font-size: 0.9em; color: #555; text-align: center; margin-top: 20px;">Pastikan semua data yang Anda isikan sudah benar sebelum mengirim.</p>
            <div style="display: flex; justify-content: space-between; margin-top: 25px; gap: 15px;">
                <button id="edit-data-btn" style="background-color: #6c757d; width: 100%; padding: 12px;">Perbaiki Data</button>
                <button id="confirm-submit-btn" style="background-color: var(--success-color); width: 100%; padding: 12px;">Ya, Kirim Data</button>
            </div>
        </div>
    </div>
    
    <div id="main-form-container">
         <div class="container">
            <header>
                <img src="https://raw.githubusercontent.com/srpcom/koesmaparkir/main/new%20logo%20rsud%202025%20kecil.png" alt="Logo" class="logo-image">
                <h1>FORMULIR LAYANAN PARKIR</h1>
                <p>RSUD dr. R. KOESMA TUBAN</p>
            </header>
            <div id="form-closed-message" class="admin-container hidden" style="text-align: center; padding: 40px;">
                <h2>Formulir Ditutup</h2>
                <p>Mohon maaf, saat ini formulir sedang ditutup sementara oleh administrator.</p>
            </div>
            <form id="parkingForm" novalidate>
                 <fieldset>
                    <legend>Tujuan Pengisian</legend>
                    <div class="form-group radio-group">
                        <label><input type="radio" name="jenisPengajuan" value="Pendaftaran Baru" onchange="toggleSections()" required> Daftar Baru</label>
                        <label><input type="radio" name="jenisPengajuan" value="Rubah Nomor Kendaraan" onchange="toggleSections()" required> Rubah Nopol</label>
                        <label><input type="radio" name="jenisPengajuan" value="Hapus Nomor Kendaraan" onchange="toggleSections()" required> Hapus Kendaraan</label>
                        <label><input type="radio" name="jenisPengajuan" value="Tambah Kendaraan Baru" onchange="toggleSections()" required> Tambah Kendaraan</label>
                        <label><input type="radio" name="jenisPengajuan" value="Buat/Ganti Kartu Parkir" onchange="toggleSections()" required> Buat/Ganti Kartu Parkir</label>
                        <label><input type="radio" name="jenisPengajuan" value="Lainnya" onchange="toggleSections()" required> Lainnya</label>
                    </div>
                    <div id="keterangan-tujuan-box" class="keterangan-box hidden">
                        <p id="desc-pendaftaran-baru" class="keterangan-text hidden">Untuk mendaftarkan kendaraan pertama Anda. Anda akan diminta mengisi detail kendaraan baru dan mengupload identitas diri.</p>
                        <p id="desc-rubah-nomor-kendaraan" class="keterangan-text hidden">Pilih ini jika Nopol kendaraan Anda berubah (misal: setelah perpanjangan STNK) namun kendaraannya masih sama. Anda perlu mengisi Nopol lama dan baru.</p>
                        <p id="desc-hapus-nomor-kendaraan" class="keterangan-text hidden">Pilih ini jika Anda tidak lagi menggunakan salah satu kendaraan yang terdaftar. Anda akan diminta mengisi Nopol kendaraan yang akan dihapus.</p>
                        <p id="desc-tambah-kendaraan-baru" class="keterangan-text hidden">Pilih ini untuk mendaftarkan kendaraan tambahan (misal: mendaftarkan motor jika sebelumnya hanya mobil). Maksimal 3 kendaraan. Anda akan mengisi detail kendaraan baru.</p>
                        <p id="desc-buat/ganti-kartu-parkir" class="keterangan-text hidden">Pilih ini jika kartu parkir Anda hilang, rusak, atau jika Anda belum pernah menerima kartu sebelumnya.</p>
                        <p id="desc-lainnya" class="keterangan-text hidden">Untuk keperluan lain yang tidak tercakup di atas. Mohon jelaskan secara rinci pada kolom keterangan yang disediakan.</p>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>Informasi Karyawan</legend>
                    <div class="form-group"><label for="namaLengkap">Nama Lengkap</label><input type="text" id="namaLengkap" name="namaLengkap" required></div>
                    <div class="form-group">
                        <label>Status Kepegawaian</label>
                        <div class="radio-group">
                            <label><input type="radio" name="statusKepegawaian" value="Karyawan RSUD" onchange="handleStatusKepegawaianChange(); handleRadioStyle(this);" required> Karyawan RSUD dr. R Koesma</label>
                            <label><input type="radio" name="statusKepegawaian" value="Pihak Ketiga" onchange="handleStatusKepegawaianChange(); handleRadioStyle(this);" required> Lainnya / Pihak Ketiga</label>
                        </div>
                    </div>
                    <div id="rsud-employee-section" class="hidden">
                        <div class="form-group">
                            <label for="unitKerja">Unit / Bagian Kerja</label>
                            <select id="unitKerja" name="unitKerja" onchange="handleUnitKerjaChange(this)">
                                <option value="">-- Pilih Unit --</option>
                                <option value="INSTALASI FARMASI">INSTALASI FARMASI</option>
                                <option value="INSTALASI RADIOLOGI">INSTALASI RADIOLOGI</option>
                                <option value="INSTALASI BEDAH SENTRAL">INSTALASI BEDAH SENTRAL</option>
                                <option value="INSTALASI GAWAT DARURAT">INSTALASI GAWAT DARURAT</option>
                                <option value="ICU">ICU</option>
                                <option value="ICCU">ICCU</option>
                                <option value="HCU">HCU</option>
                                <option value="INSTALASI LABORATORIUM">INSTALASI LABORATORIUM</option>
                                <option value="INSTALASI HEMODIALISA">INSTALASI HEMODIALISA</option>
                                <option value="INSTALASI GIZI">INSTALASI GIZI</option>
                                <option value="INSTALASI REKAM MEDIK">INSTALASI REKAM MEDIK</option>
                                <option value="INSTALASI PEMELIHARAAN SARANA">INSTALASI PEMELIHARAAN SARANA</option>
                                <option value="INSTALASI PENYEHATAN LINGKUNGAN">INSTALASI PENYEHATAN LINGKUNGAN</option>
                                <option value="INSTALASI FORENSIK DAN MEDIKOLEGAL">INSTALASI FORENSIK DAN MEDIKOLEGAL</option>
                                <option value="INSTALASI DIAGNOSTIK DAN INTERVENSI KORDIOVASKULER">INSTALASI DIAGNOSTIK DAN INTERVENSI KORDIOVASKULER</option>
                                <option value="INSTALASI MATERNAL DAN PERINATAL">INSTALASI MATERNAL DAN PERINATAL</option>
                                <option value="INSTALASI REHABILITASI MEDIK">INSTALASI REHABILITASI MEDIK</option>
                                <option value="INSTALASI SIM RS">INSTALASI SIM RS</option>
                                <option value="INSTALASI PKRS">INSTALASI PKRS</option>
                                <option value="POLI KIR">POLI KIR</option>
                                <option value="POLI EKSKUTIF">POLI EKSKUTIF</option>
                                <option value="POLI TMS">POLI TMS</option>
                                <option value="POLI EEG">POLI EEG</option>
                                <option value="POLI ENDOSKOPI">POLI ENDOSKOPI</option>
                                <option value="POLI ESWL">POLI ESWL</option>
                                <option value="RUANG MAWAR/ASTER">RUANG MAWAR/ASTER</option>
                                <option value="RUANG ANYELIR/MELATI">RUANG ANYELIR/MELATI</option>
                                <option value="RUANG ANGGREK/DAHLIA">RUANG ANGGREK/DAHLIA</option>
                                <option value="RUANG BOUGENVILLE">RUANG BOUGENVILLE</option>
                                <option value="RUANG PAVILIUN">RUANG PAVILIUN</option>
                                <option value="RUANG ISOLASI">RUANG ISOLASI</option>
                                <option value="RUANG PERINATOLOGI">RUANG PERINATOLOGI</option>
                                <option value="POLI ANAK">POLI ANAK</option>
                                <option value="POLI PENYAKIT DALAM">POLI PENYAKIT DALAM</option>
                                <option value="POLI BEDAH">POLI BEDAH</option>
                                <option value="POLI MATA">POLI MATA</option>
                                <option value="POLI THT">POLI THT</option>
                                <option value="POLI SYARAF">POLI SYARAF</option>
                                <option value="POLI JANTUNG">POLI JANTUNG</option>
                                <option value="POLI PARU">POLI PARU</option>
                                <option value="POLI GIGI">POLI GIGI</option>
                                <option value="POLI KULIT DAN KELAMIN">POLI KULIT DAN KELAMIN</option>
                                <option value="POLI JIWA">POLI JIWA</option>
                                <option value="POLI TB">POLI TB</option>
                                <option value="POLI VCT">POLI VCT</option>
                                <option value="POLI UMUM">POLI UMUM</option>
                                <option value="BAGIAN PROGPEL">BAGIAN PROGPEL</option>
                                <option value="BAGIAN KEUANGAN">BAGIAN KEUANGAN</option>
                                <option value="BAGIAN ADMINISTRASI DAN UMUM">BAGIAN ADMINISTRASI DAN UMUM</option>
                                <option value="BIDANG PELAYANAN MEDIK">BIDANG PELAYANAN MEDIK</option>
                                <option value="BIDANG KEPERAWATAN">BIDANG KEPERAWATAN</option>
                                <option value="BIDANG PELAYANAN PENUNJANG">BIDANG PENUNJANG</option>
                                <option value="KOMITE MEDIK">KOMITE MEDIK</option>
                                <option value="KOMITE KEPERAWATAN">KOMITE KEPERAWATAN</option>
                                <option value="KOMITE PPI">KOMITE PPI</option>
                                <option value="KOMITE KESEHATAN DAN KESELAMATAN KERJA">KOMITE KESEHATAN DAN KESELAMATAN KERJA</option>
                                <option value="SATUAN PEMERIKSAAN INTERNAL">SATUAN PEMERIKSAAN INTERNAL</option>
                                <option value="LAINNYA">Lainnya...</option>
                            </select>
                        </div>
                        <div class="form-group hidden" id="unitKerjaLainnya-group"><label for="unitKerjaLainnya">Tulis Nama Unit Anda</label><input type="text" id="unitKerjaLainnya" name="unitKerjaLainnya"></div>
                    </div>
                    <div id="other-employee-section" class="hidden">
                        <div class="form-group"><label for="afiliasiLainnya">Sebutkan Nama Instansi / Perusahaan Anda</label><input type="text" id="afiliasiLainnya" name="afiliasiLainnya"></div>
                    </div>
                    <div class="form-group"><label for="telepon">Nomor Telepon / WA (Aktif)</label><input type="tel" id="telepon" name="telepon" required></div>
                    <div class="form-group"><label for="fileKtp">Upload Identitas (KTP/SIM)</label><input type="file" id="fileKtp" name="fileKtp" accept=".jpg,.jpeg,.png,.pdf" required></div>
                </fieldset>
                <fieldset id="update-section" class="hidden">
                    <legend>Data Kendaraan Lama</legend>
                    <div class="form-group radio-group">
                        <label>Jenis Kendaraan Lama</label>
                        <label><input type="radio" name="jenisKendaraanLama" value="Mobil" onchange="handleRadioStyle(this)"> Mobil</label>
                        <label><input type="radio" name="jenisKendaraanLama" value="Motor" onchange="handleRadioStyle(this)"> Motor</label>
                    </div>
                    <div class="form-group"><label for="noPolisiLama">Nomor Polisi Lama</label><input type="text" id="noPolisiLama" name="noPolisiLama"></div>
                </fieldset>
                <fieldset id="card-replacement-section" class="hidden">
                    <legend>Alasan Pembuatan/Penggantian Kartu Parkir</legend>
                    <div class="form-group">
                        <label>Pilih Alasan</label>
                        <div class="radio-group">
                            <label><input type="radio" name="alasanPenggantian" value="Kartu Rusak/Hilang" onchange="handleAlasanChange(); handleRadioStyle(this)"> Kartu Rusak/Hilang</label>
                            <label><input type="radio" name="alasanPenggantian" value="Belum pernah menerima kartu" onchange="handleAlasanChange(); handleRadioStyle(this)"> Belum pernah menerima kartu</label>
                            <label><input type="radio" name="alasanPenggantian" value="Lainnya" onchange="handleAlasanChange(); handleRadioStyle(this)"> Lainnya</label>
                        </div>
                    </div>
                    <div class="form-group hidden" id="alasanLainnya-group"><label for="alasanPenggantianLainnya">Sebutkan Alasan Lainnya</label><input type="text" id="alasanPenggantianLainnya" name="alasanPenggantianLainnya"></div>
                </fieldset>
                <fieldset id="new-vehicle-section" class="hidden">
                    <legend>Detail Kendaraan Baru</legend>
                    <div class="form-group radio-group">
                        <label>Jenis Kendaraan Baru</label>
                        <label><input type="radio" name="jenisKendaraanBaru" value="Mobil" onchange="handleRadioStyle(this)"> Mobil</label>
                        <label><input type="radio" name="jenisKendaraanBaru" value="Motor" onchange="handleRadioStyle(this)"> Motor</label>
                    </div>
                    <div class="form-group"><label for="noPolisiBaru">Nomor Polisi Baru</label><input type="text" id="noPolisiBaru" name="noPolisiBaru"></div>
                </fieldset>
                <fieldset id="lainnya-section" class="hidden"><legend>Keterangan Lainnya</legend><div class="form-group"><label for="keteranganLainnya">Tulis keterangan lengkap Anda</label><textarea id="keteranganLainnya" name="keteranganLainnya" rows="5"></textarea></div></fieldset>
                <button type="submit" id="submit-button">Kirim Formulir</button>
            </form>
        </div>
    </div>
    
    <!-- HALAMAN ADMIN DIMULAI DI SINI -->
    <div id="admin-login-page" class="hidden">
        <div class="container">
            <header><h1>Login Admin</h1></header>
            <div class="admin-container">
                <div class="form-group"><label for="admin-password">Password</label><input type="password" id="admin-password" required></div>
                <button id="admin-login-button">Login</button>
                <p id="login-error" class="hidden" style="color:red; text-align:center; margin-top:10px;"></p>
            </div>
        </div>
    </div>
    <div id="admin-dashboard" class="hidden">
        <div class="container">
            <header><h1>Dashboard Admin</h1></header>
            <div class="admin-container">
                <div class="admin-section">
                    <h2>Pengaturan Formulir</h2>
                    <div class="toggle-switch">
                        <label>Formulir:</label>
                        <div id="form-status-toggle" onclick="toggleFormStatus()"><span></span></div>
                        <strong id="form-status-text"></strong>
                    </div>
                </div>
                <div class="admin-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <h2>Data Submisi</h2>
                        <button id="refresh-data" style="width:auto; padding: 5px 10px; font-size: 0.8em;" onclick="fetchPage(1)">Refresh</button>
                    </div>
                    <div class="admin-controls">
                        <input type="text" id="search-input" placeholder="Cari data...">
                        <select id="status-filter">
                            <option value="Semua">Semua Status</option>
                            <option value="Belum diproses">Belum diproses</option>
                            <option value="Selesai">Selesai</option>
                            <option value="Ditolak">Ditolak</option>
                        </select>
                        <button id="download-xlsx" class="download-button">Unduh .xlsx</button>
                    </div>
                    <div class="table-container">
                        <table id="submissions-table">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="pagination-controls" class="pagination-controls"></div>
                </div>
                <button id="logout-button">Logout</button>
            </div>
        </div>
    </div>
    <!-- HALAMAN ADMIN BERAKHIR DI SINI -->

    <footer style="text-align: center; color: #fff; font-size: 0.8em; padding: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">ver 1.4</footer>

    <script>
        // Variabel global
        const webAppUrl = 'https://script.google.com/macros/s/AKfycbz4BFMq1gjZhyzKZx5qzqPEcoNxzrQZG0NHAX_g8ym4xFU6fBFpWmONkpxgjAXxxqNY/exec';
        let formDataToSubmit = null; 
        let submissionHeaders = [];
        let currentPage = 1;
        
        // Elemen DOM
        const mainFormContainer = document.getElementById('main-form-container');
        const adminLoginPage = document.getElementById('admin-login-page');
        const adminDashboard = document.getElementById('admin-dashboard');
        const searchInput = document.getElementById('search-input');
        const statusFilter = document.getElementById('status-filter');
        const downloadButton = document.getElementById('download-xlsx');

        // --- ROUTING APLIKASI ---
        window.addEventListener('hashchange', handleRouteChange);
        window.addEventListener('load', handleRouteChange);

        function handleRouteChange() {
            if (window.location.hash === '#admin') {
                sessionStorage.getItem('isAdminAuthenticated') === 'true' ? showDashboard() : showAdminLogin();
            } else {
                showMainForm();
            }
        }
        function showMainForm() { mainFormContainer.classList.remove('hidden'); adminLoginPage.classList.add('hidden'); adminDashboard.classList.add('hidden'); document.body.classList.remove('admin-view'); checkFormStatusForUser(); }
        function showAdminLogin() { mainFormContainer.classList.add('hidden'); adminLoginPage.classList.remove('hidden'); adminDashboard.classList.add('hidden'); document.body.classList.remove('admin-view'); }
        function showDashboard() { mainFormContainer.classList.add('hidden'); adminLoginPage.classList.add('hidden'); adminDashboard.classList.remove('hidden'); document.body.classList.add('admin-view'); loadAdminData(); }
        
        // --- LOGIKA FORMULIR PENGGUNA ---
        document.getElementById('parkingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!this.checkValidity()) {
                alert('Mohon lengkapi semua kolom yang wajib diisi.');
                return;
            }
            formDataToSubmit = new FormData(this);
            displayConfirmationSummary(formDataToSubmit);
        });
        function displayConfirmationSummary(formData) {
            const summaryContainer = document.getElementById('summary-content');
            let summaryHTML = '';
            const fieldLabels = {
                jenisPengajuan: 'Tujuan Pengajuan', namaLengkap: 'Nama Lengkap', statusKepegawaian: 'Status Kepegawaian',
                unitKerja: 'Unit Kerja', unitKerjaLainnya: 'Unit Kerja Lainnya', afiliasiLainnya: 'Instansi/Perusahaan',
                telepon: 'Nomor Telepon', fileKtp: 'File Identitas', jenisKendaraanLama: 'Jenis Kendaraan Lama',
                noPolisiLama: 'Nopol Lama', alasanPenggantian: 'Alasan Ganti Kartu', alasanPenggantianLainnya: 'Alasan Lainnya',
                jenisKendaraanBaru: 'Jenis Kendaraan Baru', noPolisiBaru: 'Nopol Baru', keteranganLainnya: 'Keterangan Lainnya'
            };
            for (let [key, value] of formData.entries()) {
                if (value && value.toString().trim() !== '') {
                    let displayValue = value instanceof File ? value.name : value;
                    if (key === 'unitKerja' && value === 'LAINNYA') continue;
                    summaryHTML += `<p><span class="summary-label">${fieldLabels[key] || key}:</span> <span class="summary-value">${displayValue}</span></p>`;
                }
            }
            summaryContainer.innerHTML = summaryHTML;
            document.getElementById('confirmation-modal').style.display = 'flex';
        }
        document.getElementById('edit-data-btn').addEventListener('click', () => {
            document.getElementById('confirmation-modal').style.display = 'none';
            formDataToSubmit = null;
        });
        document.getElementById('confirm-submit-btn').addEventListener('click', () => {
            document.getElementById('confirmation-modal').style.display = 'none';
            if (formDataToSubmit) submitFinalData(formDataToSubmit);
        });
        async function submitFinalData(formData) {
            showLoading(true, "Mengirim data...");
            const formDataObject = Object.fromEntries(formData.entries());
            try {
                const fileInput = formData.get('fileKtp');
                if (fileInput && fileInput.size > 0) formDataObject.fileKtp = await compressAndReadFile(fileInput);
                const response = await fetch(webAppUrl, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(formDataObject) });
                const result = await response.json();
                if (result.status === 'success') {
                    alert('Pengajuan Anda telah berhasil dikirim!');
                    document.getElementById('parkingForm').reset();
                    toggleSections();
                    handleStatusKepegawaianChange();
                    handleAlasanChange();
                } else { throw new Error(result.message || 'Terjadi kesalahan di server.'); }
            } catch(error) {
                console.error('Submit Error:', error);
                alert('Terjadi kesalahan koneksi. Pesan: ' + error.message);
            } finally {
                showLoading(false);
                formDataToSubmit = null;
            }
        }
        
        // --- LOGIKA HALAMAN ADMIN ---
        document.getElementById('admin-login-button').addEventListener('click', adminLogin);
        document.getElementById('logout-button').addEventListener('click', adminLogout);
        searchInput.addEventListener('keyup', () => fetchPage(1));
        statusFilter.addEventListener('change', () => fetchPage(1));
        downloadButton.addEventListener('click', downloadXLSX);

        async function adminLogin() {
            const password = document.getElementById('admin-password').value;
            const loginError = document.getElementById('login-error');
            showLoading(true, "Memverifikasi...");
            try {
                const response = await fetch(`${webAppUrl}?action=adminLogin&password=${encodeURIComponent(password)}`);
                const result = await response.json();
                if (result.status === 'success') {
                    sessionStorage.setItem('isAdminAuthenticated', 'true');
                    loginError.classList.add('hidden');
                    document.getElementById('admin-password').value = '';
                    showDashboard();
                } else {
                    loginError.textContent = result.message || "Password salah.";
                    loginError.classList.remove('hidden');
                }
            } catch (error) { loginError.textContent = "Gagal terhubung ke server."; loginError.classList.remove('hidden'); } 
            finally { showLoading(false); }
        }
        function adminLogout() { sessionStorage.removeItem('isAdminAuthenticated'); document.body.classList.remove('admin-view'); window.location.hash = ''; }
        async function loadAdminData() { await loadSettings(); await fetchPage(1); }
        async function loadSettings() {
            try {
                const response = await fetch(`${webAppUrl}?action=getSettings`);
                const result = await response.json();
                if (result.status === 'success') {
                    const status = result.data.formStatus;
                    const toggle = document.getElementById('form-status-toggle');
                    toggle.classList.toggle('on', status === 'ON');
                    document.getElementById('form-status-text').textContent = status;
                }
            } catch (e) { console.error("Gagal memuat pengaturan:", e); }
        }
        async function toggleFormStatus() {
            const newStatus = document.getElementById('form-status-toggle').classList.contains('on') ? 'OFF' : 'ON';
            showLoading(true, 'Memperbarui...');
            try {
                await fetch(`${webAppUrl}?action=updateSettings&formStatus=${newStatus}`);
                await loadSettings();
            } catch (e) { console.error("Gagal mengubah status:", e); }
            finally { showLoading(false); }
        }
        async function fetchPage(page) {
            currentPage = page;
            const searchTerm = searchInput.value;
            const status = statusFilter.value;
            showLoading(true, "Memuat data...");
            const tableBody = document.querySelector('#submissions-table tbody');
            tableBody.innerHTML = `<tr><td colspan="15" style="text-align:center;">Memuat data...</td></tr>`;
            try {
                const url = new URL(webAppUrl);
                url.searchParams.append('action', 'getSubmissions');
                url.searchParams.append('page', page);
                url.searchParams.append('searchTerm', searchTerm);
                url.searchParams.append('statusFilter', status);
                const response = await fetch(url);
                const result = await response.json();
                if (result.status === 'success') {
                    const { headers, pageData, currentPage, totalPages } = result.data;
                    submissionHeaders = headers;
                    displayData(pageData);
                    setupPagination(currentPage, totalPages);
                } else { tableBody.innerHTML = `<tr><td colspan="15" style="text-align:center; color:red;">Gagal: ${result.message}</td></tr>`; }
            } catch (e) { tableBody.innerHTML = `<tr><td colspan="15" style="text-align:center; color:red;">Gagal terhubung.</td></tr>`; } 
            finally { showLoading(false); }
        }
        function displayData(pageData) {
            const tableBody = document.querySelector('#submissions-table tbody');
            const tableHead = document.querySelector('#submissions-table thead');
            tableBody.innerHTML = '';
            tableHead.innerHTML = `<tr>${submissionHeaders.map(h => `<th>${h}</th>`).join('')}</tr>`;
            if (!pageData || pageData.length === 0) {
                tableBody.innerHTML = `<tr><td data-label="Info" colspan="${submissionHeaders.length || 1}" style="text-align:center;">Data tidak ditemukan.</td></tr>`;
                return;
            }
            pageData.forEach(item => {
                const { rowData, originalIndex } = item;
                const tr = document.createElement('tr');
                rowData.forEach((cell, cellIndex) => {
                    const td = document.createElement('td');
                    const header = submissionHeaders[cellIndex];
                    td.setAttribute('data-label', header);
                    if (header === 'Status') {
                        const select = document.createElement('select');
                        select.innerHTML = `<option value="Belum diproses">Belum diproses</option><option value="Selesai">Selesai</option><option value="Ditolak">Ditolak</option><option value="Hapus">Hapus</option>`;
                        select.value = cell;
                        select.onchange = (event) => handleStatusChange(event.target, originalIndex);
                        td.appendChild(select);
                        updateSelectColor(select);
                    } else if (header === 'Link File Identitas' && cell && cell.startsWith('http')) {
                        td.innerHTML = `<a href="${cell}" target="_blank" rel="noopener noreferrer">Lihat File</a>`;
                    } else { td.textContent = cell; }
                    if (header !== 'Status' && (!cell || cell.toString().trim() === '')) td.classList.add('empty-cell');
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }
        function setupPagination(currentPage, totalPages) {
            const paginationControls = document.getElementById('pagination-controls');
            if (totalPages <= 1) { paginationControls.innerHTML = ''; return; }
            paginationControls.innerHTML = `<button onclick="fetchPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>«</button><span class="page-info">Hal ${currentPage} dari ${totalPages}</span><button onclick="fetchPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>»</button>`;
        }
        function handleStatusChange(selectElement, rowIndex) {
            updateSelectColor(selectElement);
            if (selectElement.value === 'Hapus') {
                if (confirm('Apakah Anda yakin ingin menghapus data ini secara permanen?')) {
                    updateStatus(selectElement.value, rowIndex);
                } else {
                    fetchPage(currentPage); // Refresh data jika dibatalkan
                }
            } else {
                updateStatus(selectElement.value, rowIndex);
            }
        }
        function updateSelectColor(selectElement) {
            selectElement.className = '';
            const value = selectElement.value;
            if (value === 'Belum diproses') selectElement.classList.add('status-pending');
            else if (value === 'Selesai') selectElement.classList.add('status-selesai');
            else if (value === 'Ditolak') selectElement.classList.add('status-ditolak');
        }
        async function updateStatus(newStatus, rowIndex) {
            showLoading(true, 'Menyimpan...');
            try {
                await fetch(`${webAppUrl}?action=updateStatus&rowIndex=${rowIndex}&status=${encodeURIComponent(newStatus)}`);
                if (newStatus === 'Hapus') {
                    await fetchPage(currentPage); // Refresh jika berhasil hapus
                }
            } catch (e) { alert("Gagal menyimpan status."); } 
            finally { showLoading(false); }
        }
        async function downloadXLSX() {
            showLoading(true, "Mempersiapkan unduhan...");
            try {
                const url = new URL(webAppUrl);
                url.searchParams.append('action', 'downloadData');
                url.searchParams.append('searchTerm', searchInput.value);
                url.searchParams.append('statusFilter', statusFilter.value);
                const response = await fetch(url);
                const result = await response.json();
                if (result.status === 'success' && result.data.rows.length > 0) {
                    const { headers, rows } = result.data;
                    const worksheet = XLSX.utils.aoa_to_sheet([headers, ...rows]);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Submisi");
                    XLSX.writeFile(workbook, "Data_Parkir_Karyawan.xlsx");
                } else { alert("Tidak ada data untuk diunduh."); }
            } catch(e) { alert("Gagal mengunduh data."); } 
            finally { showLoading(false); }
        }

        // --- FUNGSI HELPERS & INISIALISASI ---
        async function checkFormStatusForUser() { try { const response = await fetch(`${webAppUrl}?action=getSettings`); const result = await response.json(); const isOff = result.status === 'success' && result.data.formStatus === 'OFF'; document.getElementById('parkingForm').classList.toggle('hidden', isOff); document.getElementById('form-closed-message').classList.toggle('hidden', !isOff); } catch(e) { console.error("Gagal memeriksa status form.", e); } }
        const formSections = { update: document.getElementById('update-section'), cardReplacement: document.getElementById('card-replacement-section'), newVehicle: document.getElementById('new-vehicle-section'), lainnya: document.getElementById('lainnya-section') };
        function toggleSections(){ const choice = document.querySelector('input[name="jenisPengajuan"]:checked')?.value; handleRadioStyle(document.querySelector(`input[name="jenisPengajuan"][value="${choice}"]`)); const allDescriptions = document.querySelectorAll('.keterangan-text'); const keteranganBox = document.getElementById('keterangan-tujuan-box'); allDescriptions.forEach(desc => desc.classList.add('hidden')); keteranganBox.classList.add('hidden'); if (choice) { const descriptionId = `desc-${choice.toLowerCase().replace(/\//g, '-').replace(/ /g, '-')}`; const descriptionEl = document.getElementById(descriptionId); if (descriptionEl) { keteranganBox.classList.remove('hidden'); descriptionEl.classList.remove('hidden'); } } Object.values(formSections).forEach(s => s.style.display = 'none'); if (!choice) return; const show = (keys) => keys.forEach(k => formSections[k].style.display = 'block'); switch(choice){ case 'Pendaftaran Baru': case 'Tambah Kendaraan Baru': show(['newVehicle']); break; case 'Rubah Nomor Kendaraan': show(['update', 'newVehicle']); break; case 'Hapus Nomor Kendaraan': show(['update']); break; case 'Buat/Ganti Kartu Parkir': show(['update', 'cardReplacement']); handleAlasanChange(); break; case 'Lainnya': show(['lainnya']); break; } }
        function handleStatusKepegawaianChange() { const choice = document.querySelector('input[name="statusKepegawaian"]:checked')?.value; const rsudSection = document.getElementById('rsud-employee-section'); const otherSection = document.getElementById('other-employee-section'); const unitKerjaSelect = document.getElementById('unitKerja'); const afiliasiInput = document.getElementById('afiliasiLainnya'); if (choice === 'Karyawan RSUD') { rsudSection.classList.remove('hidden'); otherSection.classList.add('hidden'); unitKerjaSelect.required = true; afiliasiInput.required = false; afiliasiInput.value = ''; } else if (choice === 'Pihak Ketiga') { rsudSection.classList.add('hidden'); otherSection.classList.remove('hidden'); unitKerjaSelect.required = false; afiliasiInput.required = true; unitKerjaSelect.value = ''; handleUnitKerjaChange(unitKerjaSelect); } else { rsudSection.classList.add('hidden'); otherSection.classList.add('hidden'); unitKerjaSelect.required = false; afiliasiInput.required = false; } }
        function handleAlasanChange() { const choice = document.querySelector('input[name="alasanPenggantian"]:checked')?.value; const lainnyaGroup = document.getElementById('alasanLainnya-group'); const lainnyaInput = document.getElementById('alasanPenggantianLainnya'); const isLainnya = choice === 'Lainnya'; lainnyaGroup.classList.toggle('hidden', !isLainnya); lainnyaInput.required = isLainnya; if (!isLainnya) lainnyaInput.value = ''; }
        function handleRadioStyle(radioElement) { if (!radioElement) return; const radioName = radioElement.name; const allLabels = document.querySelectorAll(`input[name="${radioName}"]`); allLabels.forEach(radio => { radio.parentElement.classList.remove('selected-label'); }); radioElement.parentElement.classList.add('selected-label'); }
        function handleUnitKerjaChange(select){ const lainnyaGroup = document.getElementById('unitKerjaLainnya-group'); const lainnyaInput = document.getElementById('unitKerjaLainnya'); const isLainnya = select.value === 'LAINNYA'; lainnyaGroup.classList.toggle('hidden', !isLainnya); lainnyaInput.required = isLainnya; if (!isLainnya) lainnyaInput.value = ''; }
        function compressAndReadFile(file){ return new Promise((resolve, reject) => { if (!file.type.startsWith('image/')) { const reader = new FileReader(); reader.onload = () => resolve({ base64: reader.result.split(',')[1], type: file.type, name: file.name }); reader.onerror = reject; reader.readAsDataURL(file); return; } const reader = new FileReader(); reader.onload = e => { const img = new Image(); img.onload = () => { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const MAX_WIDTH = 1024; const scaleSize = MAX_WIDTH / img.width; canvas.width = MAX_WIDTH; canvas.height = img.height * scaleSize; ctx.drawImage(img, 0, 0, canvas.width, canvas.height); const dataUrl = canvas.toDataURL('image/jpeg', 0.8); resolve({ base64: dataUrl.split(',')[1], type: 'image/jpeg', name: 'compressed_id.jpg' }); }; img.src = e.target.result; }; reader.onerror = reject; reader.readAsDataURL(file); }); }
        function showLoading(show, message = "Mohon tunggu...") { const overlay = document.getElementById('loading-overlay'); overlay.style.display = show ? 'flex' : 'none'; overlay.querySelector('p').textContent = message; }
        window.addEventListener('load', () => { handleRouteChange(); toggleSections(); });
    </script>
</body>
</html>

