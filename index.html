<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Layanan Parkir RSUD</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/srpcom/koesmaparkir/main/new%20logo%20rsud%202025%20kecil.png">
    
    <!-- Library Google Sign-In (SSO) -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Library Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary-color: #005A9C; 
            --primary-dark: #00487a;
            --secondary-color: #F0F8FF; 
            --text-color: #333; 
            --success-color: #28a745; 
            --error-color: #dc3545;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.4);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background-image: url('https://raw.githubusercontent.com/srpcom/koesmaparkir/main/foto%20ipit.jpg'); 
            background-size: cover; 
            background-position: center; 
            background-attachment: fixed; 
            color: var(--text-color); 
            margin: 0; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Overlay gelap untuk background agar text lebih terbaca */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.1);
            z-index: -1;
        }

        .container { 
            max-width: 800px; 
            width: 95%; 
            margin: 30px auto; 
            background-color: var(--glass-bg); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px); 
            border-radius: 16px; 
            box-shadow: var(--shadow); 
            border: 1px solid var(--glass-border); 
            overflow: hidden;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- LOGIN PAGE STYLE --- */
        #login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            width: 100%;
            position: fixed;
            top: 0; left: 0;
            z-index: 2000;
            background: rgba(0,90,156, 0.1);
            backdrop-filter: blur(5px);
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 90%;
        }

        .login-card img {
            width: 80px;
            margin-bottom: 20px;
        }

        .login-card h2 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .login-card p {
            color: #666;
            margin-bottom: 30px;
            font-size: 0.95em;
        }

        /* --- HEADER & FORM --- */
        header { 
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); 
            color: white; 
            padding: 25px; 
            text-align: center; 
        }
        
        header .logo-image { width: 60px; margin-bottom: 10px; }
        header h1 { margin: 0; font-size: 1.4em; letter-spacing: 0.5px; }
        header p { margin: 5px 0 0; font-size: 0.9em; opacity: 0.9; }

        .user-info-bar {
            background-color: #e3f2fd;
            color: var(--primary-dark);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .logout-link {
            color: var(--error-color);
            text-decoration: underline;
            cursor: pointer;
            font-weight: bold;
        }

        form { padding: 25px; }

        fieldset { 
            border: 1px solid #e0e0e0; 
            border-radius: 10px; 
            padding: 20px; 
            margin-bottom: 25px; 
            background-color: rgba(255, 255, 255, 0.6); 
        }

        legend { 
            font-weight: bold; 
            color: var(--primary-color); 
            padding: 5px 15px; 
            background: #fff; 
            border-radius: 20px; 
            border: 1px solid #eee;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.95em; color: #444; }
        
        input[type="text"], input[type="tel"], select, textarea, input[type="file"] { 
            width: 100%; 
            padding: 12px 15px; 
            border: 1px solid #ccc; 
            border-radius: 8px; 
            box-sizing: border-box; 
            font-size: 15px; 
            background-color: #fff;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0,90,156, 0.1);
        }

        /* Custom Radio Buttons */
        .radio-group { display: flex; flex-direction: column; gap: 10px; }
        .radio-group label { 
            display: flex; 
            align-items: center; 
            margin: 0; 
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #eee;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .radio-group label:hover { background: #f8f9fa; }
        .radio-group label.selected-label { 
            background: #e3f2fd; 
            border-color: var(--primary-color); 
            color: var(--primary-color);
            font-weight: bold;
        }
        .radio-group input { margin-right: 12px; accent-color: var(--primary-color); width: 18px; height: 18px; }

        button { 
            width: 100%; 
            padding: 16px; 
            background-color: var(--primary-color); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 1.1em; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 0 4px 6px rgba(0,90,156, 0.2);
            transition: all 0.3s; 
        }
        
        button:hover { background-color: var(--primary-dark); transform: translateY(-2px); }
        
        .hidden { display: none !important; }

        /* Status Colors & Admin Table */
        .status-pending { background-color: #fffbe6; color: #d48806; border: 1px solid #ffe58f; }
        .status-selesai { background-color: #f6ffed; color: #389e0d; border: 1px solid #b7eb8f; }
        .status-ditolak { background-color: #fff1f0; color: #cf1322; border: 1px solid #ffa39e; }

        /* Admin Dashboard Specifics */
        .admin-view body { background: #f0f2f5; padding: 0; }
        #admin-dashboard .container { max-width: 100%; margin: 0; border-radius: 0; height: 100vh; display: flex; flex-direction: column; }
        .admin-content { flex: 1; padding: 20px; overflow-y: auto; }
        
        #submissions-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; background: white; }
        #submissions-table th { background-color: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #ddd; }
        #submissions-table td { padding: 12px; border-bottom: 1px solid #eee; }
        
        /* Loading Overlay */
        .overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.7); z-index: 3000; 
            display: none; justify-content: center; align-items: center; 
            backdrop-filter: blur(5px); flex-direction: column;
        }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .overlay p { color: white; margin-top: 15px; font-weight: bold; }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .container { width: 100%; margin: 0; border-radius: 0; border: none; }
            #admin-dashboard .container { height: auto; min-height: 100vh; }
            #submissions-table thead { display: none; }
            #submissions-table tr { display: block; margin-bottom: 15px; border: 1px solid #eee; border-radius: 8px; background: white; padding: 10px; }
            #submissions-table td { display: flex; justify-content: space-between; text-align: right; border: none; border-bottom: 1px solid #f0f0f0; padding: 8px 0; }
            #submissions-table td::before { content: attr(data-label); font-weight: bold; color: #555; text-align: left; margin-right: 10px; }
        }
    </style>
</head>
<body>

    <!-- 1. HALAMAN LOGIN SSO -->
    <div id="login-page">
        <div class="login-card">
            <img src="https://raw.githubusercontent.com/srpcom/koesmaparkir/main/new%20logo%20rsud%202025%20kecil.png" alt="Logo RSUD">
            <h2>Selamat Datang</h2>
            <p>Silakan login menggunakan akun Google Anda untuk mengakses Layanan Parkir.</p>
            
            <!-- Google Sign-In Button Container -->
            <div id="g_id_onload"
                 data-client_id="783459415718-mp0vsmd2lopajf2ut0aqc6drjrs95pu8.apps.googleusercontent.com"
                 data-callback="handleCredentialResponse"
                 data-auto_prompt="false">
            </div>
            <div class="g_id_signin"
                 data-type="standard"
                 data-size="large"
                 data-theme="outline"
                 data-text="sign_in_with"
                 data-shape="pill"
                 data-logo_alignment="left">
            </div>
        </div>
    </div>

    <!-- 2. LOADING OVERLAY -->
    <div id="loading-overlay" class="overlay">
        <div class="spinner"></div>
        <p>Memproses data...</p>
    </div>

    <!-- 3. HALAMAN USER FORMULIR -->
    <div id="main-form-container" class="hidden">
         <div class="container">
            <header>
                <img src="https://raw.githubusercontent.com/srpcom/koesmaparkir/main/new%20logo%20rsud%202025%20kecil.png" alt="Logo" class="logo-image">
                <h1>FORMULIR LAYANAN PARKIR</h1>
                <p>RSUD dr. R. KOESMA TUBAN</p>
            </header>
            
            <div class="user-info-bar">
                <span id="user-display-name">Halo, User</span>
                <span class="logout-link" onclick="handleLogout()">Keluar</span>
            </div>

            <div id="form-closed-message" class="hidden" style="text-align: center; padding: 40px;">
                <h2 style="color: var(--error-color);">Formulir Ditutup</h2>
                <p>Mohon maaf, saat ini formulir sedang ditutup sementara oleh administrator.</p>
            </div>

            <form id="parkingForm" novalidate>
                <!-- Field hidden untuk menyimpan email SSO -->
                <input type="hidden" id="emailAkunGoogle" name="emailAkunGoogle">

                <!-- STEP 1: INFORMASI KARYAWAN (Wajib Diisi Pertama Kali) -->
                <fieldset>
                    <legend>Informasi Karyawan</legend>
                    <div style="background-color: #e8f4fc; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em; border-left: 4px solid var(--primary-color);">
                        <strong>Info:</strong> Mohon lengkapi data diri Anda dengan benar. Data ini akan digunakan untuk verifikasi parkir.
                    </div>

                    <div class="form-group">
                        <label for="namaLengkap">Nama Lengkap</label>
                        <input type="text" id="namaLengkap" name="namaLengkap" required placeholder="Sesuai KTP">
                    </div>

                    <div class="form-group">
                        <label>Status Kepegawaian</label>
                        <div class="radio-group">
                            <label><input type="radio" name="statusKepegawaian" value="Karyawan RSUD" onchange="handleStatusKepegawaianChange(); handleRadioStyle(this);" required> Karyawan RSUD dr. R Koesma</label>
                            <label><input type="radio" name="statusKepegawaian" value="Pihak Ketiga" onchange="handleStatusKepegawaianChange(); handleRadioStyle(this);" required> Lainnya / Pihak Ketiga</label>
                        </div>
                    </div>

                    <!-- Pilihan Unit Kerja (Sama seperti sebelumnya) -->
                    <div id="rsud-employee-section" class="hidden">
                        <div class="form-group">
                            <label for="unitKerja">Unit / Bagian Kerja</label>
                            <select id="unitKerja" name="unitKerja" onchange="handleUnitKerjaChange(this)">
                                <option value="">-- Pilih Unit --</option>
                                <option value="INSTALASI FARMASI">INSTALASI FARMASI</option>
                                <option value="INSTALASI RADIOLOGI">INSTALASI RADIOLOGI</option>
                                <option value="INSTALASI BEDAH SENTRAL">INSTALASI BEDAH SENTRAL</option>
                                <option value="INSTALASI GAWAT DARURAT">INSTALASI GAWAT DARURAT</option>
                                <option value="ICU">ICU</option>
                                <option value="ICCU">ICCU</option>
                                <option value="HCU">HCU</option>
                                <option value="INSTALASI LABORATORIUM">INSTALASI LABORATORIUM</option>
                                <option value="INSTALASI HEMODIALISA">INSTALASI HEMODIALISA</option>
                                <option value="INSTALASI GIZI">INSTALASI GIZI</option>
                                <option value="INSTALASI REKAM MEDIK">INSTALASI REKAM MEDIK</option>
                                <option value="INSTALASI PEMELIHARAAN SARANA">INSTALASI PEMELIHARAAN SARANA</option>
                                <option value="INSTALASI PENYEHATAN LINGKUNGAN">INSTALASI PENYEHATAN LINGKUNGAN</option>
                                <option value="INSTALASI FORENSIK DAN MEDIKOLEGAL">INSTALASI FORENSIK DAN MEDIKOLEGAL</option>
                                <option value="INSTALASI DIAGNOSTIK DAN INTERVENSI KORDIOVASKULER">INSTALASI DIAGNOSTIK DAN INTERVENSI KORDIOVASKULER</option>
                                <option value="INSTALASI MATERNAL DAN PERINATAL">INSTALASI MATERNAL DAN PERINATAL</option>
                                <option value="INSTALASI REHABILITASI MEDIK">INSTALASI REHABILITASI MEDIK</option>
                                <option value="INSTALASI SIM RS">INSTALASI SIM RS</option>
                                <option value="INSTALASI PKRS">INSTALASI PKRS</option>
                                <option value="POLI KIR">POLI KIR</option>
                                <option value="POLI EKSKUTIF">POLI EKSKUTIF</option>
                                <option value="POLI TMS">POLI TMS</option>
                                <option value="POLI EEG">POLI EEG</option>
                                <option value="POLI ENDOSKOPI">POLI ENDOSKOPI</option>
                                <option value="POLI ESWL">POLI ESWL</option>
                                <option value="RUANG MAWAR/ASTER">RUANG MAWAR/ASTER</option>
                                <option value="RUANG ANYELIR/MELATI">RUANG ANYELIR/MELATI</option>
                                <option value="RUANG ANGGREK/DAHLIA">RUANG ANGGREK/DAHLIA</option>
                                <option value="RUANG BOUGENVILLE">RUANG BOUGENVILLE</option>
                                <option value="RUANG TERATAI/ASOKA">RUANG TERATAI/ASOKA</option>
                                <option value="RUANG LILY">RUANG LILY</option>
                                <option value="RUANG FLAMBOYAN">RUANG FLAMBOYAN</option>
                                <option value="POLI ANAK">POLI ANAK</option>
                                <option value="POLI PENYAKIT DALAM">POLI PENYAKIT DALAM</option>
                                <option value="POLI BEDAH">POLI BEDAH</option>
                                <option value="POLI MATA">POLI MATA</option>
                                <option value="POLI THT">POLI THT</option>
                                <option value="POLI SYARAF">POLI SYARAF</option>
                                <option value="POLI JANTUNG">POLI JANTUNG</option>
                                <option value="POLI PARU">POLI PARU</option>
                                <option value="POLI GIGI">POLI GIGI</option>
                                <option value="POLI KULIT DAN KELAMIN">POLI KULIT DAN KELAMIN</option>
                                <option value="POLI JIWA">POLI JIWA</option>
                                <option value="POLI TB">POLI TB</option>
                                <option value="POLI VCT">POLI VCT</option>
                                <option value="POLI UMUM">POLI UMUM</option>
                                <option value="POLI GERIATRI">POLI GERIATRI</option>
                                <option value="POLI UROLOGI">POLI UROLOGI</option>
                                <option value="POLI ORTHOPEDI">POLI ORTHOPEDI</option>
                                <option value="POLI OBSGYN">POLI OBSGYN</option>
                                <option value="POLI BEDAH SYARAF">POLI BEDAH SYARAF</option>
                                <option value="BAGIAN PROGPEL">BAGIAN PROGPEL</option>
                                <option value="BAGIAN KEUANGAN">BAGIAN KEUANGAN</option>
                                <option value="BAGIAN ADMINISTRASI DAN UMUM">BAGIAN ADMINISTRASI DAN UMUM</option>
                                <option value="BIDANG PELAYANAN MEDIK">BIDANG PELAYANAN MEDIK</option>
                                <option value="BIDANG KEPERAWATAN">BIDANG KEPERAWATAN</option>
                                <option value="BIDANG PELAYANAN PENUNJANG">BIDANG PENUNJANG</option>
                                <option value="KOMITE MEDIK">KOMITE MEDIK</option>
                                <option value="KOMITE KEPERAWATAN">KOMITE KEPERAWATAN</option>
                                <option value="KOMITE PPI">KOMITE PPI</option>
                                <option value="KOMITE KESEHATAN DAN KESELAMATAN KERJA">KOMITE KESEHATAN DAN KESELAMATAN KERJA</option>
                                <option value="SATUAN PEMERIKSAAN INTERNAL">SATUAN PEMERIKSAAN INTERNAL</option>
                                <option value="UNIT AMBULAN">UNIT AMBULAN</option>
                                <option value="UNIT LOUNDRY">UNIT LOUNDRY</option>
                                <option value="UNIT CSSD">UNIT CSSD</option>
                                <option value="UNIT PENGADUAN">UNIT PENGADUAN</option>
                                <option value="UNIT DIKLAT">UNIT DIKLAT</option>
                                <option value="UNIT KLAIM DAN PENJAMINAN">UNIT KLAIM DAN PENJAMINAN</option>
                                <option value="LAINNYA">Lainnya...</option>
                            </select>
                        </div>
                        <div class="form-group hidden" id="unitKerjaLainnya-group"><label for="unitKerjaLainnya">Tulis Nama Unit Anda</label><input type="text" id="unitKerjaLainnya" name="unitKerjaLainnya"></div>
                    </div>
                    <div id="other-employee-section" class="hidden">
                        <div class="form-group"><label for="afiliasiLainnya">Sebutkan Nama Instansi / Perusahaan Anda</label><input type="text" id="afiliasiLainnya" name="afiliasiLainnya"></div>
                    </div>
                    <div class="form-group">
                        <label for="telepon">Nomor Telepon / WA (Aktif)</label>
                        <input type="tel" id="telepon" name="telepon" required placeholder="08xxxxxxxxxx">
                    </div>
                    <div class="form-group"><label for="fileKtp">Upload Identitas (KTP/SIM)</label><input type="file" id="fileKtp" name="fileKtp" accept=".jpg,.jpeg,.png,.pdf" required></div>
                </fieldset>

                <!-- STEP 2: TUJUAN PENGISIAN -->
                <fieldset>
                    <legend>Tujuan Pengisian</legend>
                    <div class="form-group radio-group">
                        <label><input type="radio" name="jenisPengajuan" value="Pendaftaran Baru" onchange="toggleSections()" required> Daftar Baru</label>
                        <label><input type="radio" name="jenisPengajuan" value="Rubah Nomor Kendaraan" onchange="toggleSections()" required> Rubah Nopol</label>
                        <label><input type="radio" name="jenisPengajuan" value="Hapus Nomor Kendaraan" onchange="toggleSections()" required> Hapus Kendaraan</label>
                        <label><input type="radio" name="jenisPengajuan" value="Tambah Kendaraan Baru" onchange="toggleSections()" required> Tambah Kendaraan</label>
                        <label><input type="radio" name="jenisPengajuan" value="Buat/Ganti Kartu Parkir" onchange="toggleSections()" required> Buat/Ganti Kartu Parkir</label>
                        <label><input type="radio" name="jenisPengajuan" value="Lainnya" onchange="toggleSections()" required> Lainnya</label>
                    </div>
                </fieldset>

                <fieldset id="update-section" class="hidden">
                    <legend>Data Kendaraan Lama</legend>
                    <div class="form-group radio-group">
                        <label>Jenis Kendaraan Lama</label>
                        <label><input type="radio" name="jenisKendaraanLama" value="Mobil" onchange="handleRadioStyle(this)"> Mobil</label>
                        <label><input type="radio" name="jenisKendaraanLama" value="Motor" onchange="handleRadioStyle(this)"> Motor</label>
                    </div>
                    <div class="form-group"><label for="noPolisiLama">Nomor Polisi Lama</label><input type="text" id="noPolisiLama" name="noPolisiLama"></div>
                </fieldset>

                <fieldset id="card-replacement-section" class="hidden">
                    <legend>Alasan Kartu Parkir</legend>
                    <div class="form-group">
                        <div class="radio-group">
                            <label><input type="radio" name="alasanPenggantian" value="Kartu Rusak/Hilang" onchange="handleAlasanChange(); handleRadioStyle(this)"> Kartu Rusak/Hilang</label>
                            <label><input type="radio" name="alasanPenggantian" value="Belum pernah menerima kartu" onchange="handleAlasanChange(); handleRadioStyle(this)"> Belum pernah menerima kartu</label>
                            <label><input type="radio" name="alasanPenggantian" value="Lainnya" onchange="handleAlasanChange(); handleRadioStyle(this)"> Lainnya</label>
                        </div>
                    </div>
                    <div class="form-group hidden" id="alasanLainnya-group"><label for="alasanPenggantianLainnya">Sebutkan Alasan Lainnya</label><input type="text" id="alasanPenggantianLainnya" name="alasanPenggantianLainnya"></div>
                </fieldset>

                <fieldset id="new-vehicle-section" class="hidden">
                    <legend>Detail Kendaraan Baru</legend>
                    <div class="form-group radio-group">
                        <label>Jenis Kendaraan Baru</label>
                        <label><input type="radio" name="jenisKendaraanBaru" value="Mobil" onchange="handleRadioStyle(this)"> Mobil</label>
                        <label><input type="radio" name="jenisKendaraanBaru" value="Motor" onchange="handleRadioStyle(this)"> Motor</label>
                    </div>
                    <div class="form-group"><label for="noPolisiBaru">Nomor Polisi Baru</label><input type="text" id="noPolisiBaru" name="noPolisiBaru"></div>
                </fieldset>

                <fieldset id="lainnya-section" class="hidden"><legend>Keterangan Lainnya</legend><div class="form-group"><label for="keteranganLainnya">Tulis keterangan lengkap Anda</label><textarea id="keteranganLainnya" name="keteranganLainnya" rows="5"></textarea></div></fieldset>
                
                <button type="submit" id="submit-button">Kirim Formulir</button>
            </form>
        </div>
    </div>

    <!-- 4. HALAMAN DASHBOARD ADMIN (KHUSUS SUPERADMIN) -->
    <div id="admin-dashboard" class="hidden">
        <div class="container">
            <header>
                <h1>Dashboard Admin</h1>
                <div class="user-info-bar" style="background: transparent; color: white; border: none; justify-content: center;">
                    <span id="admin-display-name">Superadmin Mode</span>
                </div>
            </header>
            
            <div class="admin-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                         <h3 style="margin:0; color: var(--primary-color);">Kontrol Formulir</h3>
                         <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                            <button id="toggle-form-btn" onclick="toggleFormStatus()" style="width: auto; padding: 5px 15px; font-size: 0.9em; background: #666;">Status: Loading...</button>
                         </div>
                    </div>
                    <button onclick="handleLogout()" style="width: auto; background-color: var(--error-color);">Logout</button>
                </div>

                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <input type="text" id="search-input" placeholder="Cari Nama / Nopol..." style="flex: 1;">
                        <select id="status-filter" style="flex: 0 0 150px;">
                            <option value="Semua">Semua Status</option>
                            <option value="Belum diproses">Belum diproses</option>
                            <option value="Selesai">Selesai</option>
                            <option value="Ditolak">Ditolak</option>
                        </select>
                        <button onclick="fetchPage(1)" style="width: auto;">Cari</button>
                        <button id="download-xlsx" style="width: auto; background-color: var(--success-color);">Download Excel</button>
                    </div>

                    <div style="overflow-x: auto;">
                        <table id="submissions-table">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="pagination-controls" style="margin-top: 20px; text-align: center;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- KONFIGURASI ---
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz4BFMq1gjZhyzKZx5qzqPEcoNxzrQZG0NHAX_g8ym4xFU6fBFpWmONkpxgjAXxxqNY/exec';
        const SUPERADMIN_EMAIL = 'syamsul18782@gmail.com';
        
        let currentUserEmail = '';
        let submissionHeaders = [];
        let currentPage = 1;

        // --- GOOGLE SSO HANDLER ---
        function handleCredentialResponse(response) {
            const responsePayload = decodeJwtResponse(response.credential);
            
            console.log("ID: " + responsePayload.sub);
            console.log('Full Name: ' + responsePayload.name);
            console.log('Given Name: ' + responsePayload.given_name);
            console.log('Family Name: ' + responsePayload.family_name);
            console.log("Image URL: " + responsePayload.picture);
            console.log("Email: " + responsePayload.email);

            currentUserEmail = responsePayload.email;
            
            // Simpan sesi di localStorage
            localStorage.setItem('userEmail', currentUserEmail);
            localStorage.setItem('userName', responsePayload.name);

            document.getElementById('login-page').classList.add('hidden');

            if (currentUserEmail === SUPERADMIN_EMAIL) {
                // LOGIKA ADMIN
                document.getElementById('admin-display-name').textContent = `Admin: ${responsePayload.name}`;
                showDashboard();
            } else {
                // LOGIKA USER BIASA
                document.getElementById('user-display-name').textContent = `Login sebagai: ${responsePayload.name}`;
                document.getElementById('emailAkunGoogle').value = currentUserEmail;
                
                // Auto-fill Nama Lengkap jika belum diisi manual
                const namaInput = document.getElementById('namaLengkap');
                if(!namaInput.value) namaInput.value = responsePayload.name;
                
                showMainForm();
            }
        }

        // Fungsi Decode JWT tanpa library eksternal yang berat
        function decodeJwtResponse(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        function handleLogout() {
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userName');
            location.reload(); // Refresh halaman untuk kembali ke login screen
        }

        // Cek sesi saat load (opsional, tapi Google Button menangani ini dengan baik)
        window.onload = function() {
            // Kita biarkan tombol Google yang menangani flow login agar token selalu segar
            // Tapi jika ingin persistensi refresh, bisa ditambahkan logika cek localStorage di sini
            
            // Inisialisasi UI
            toggleSections();
        };

        function showMainForm() {
            document.getElementById('main-form-container').classList.remove('hidden');
            document.getElementById('admin-dashboard').classList.add('hidden');
            document.body.classList.remove('admin-view');
            checkFormStatusForUser();
        }

        function showDashboard() {
            document.getElementById('main-form-container').classList.add('hidden');
            document.getElementById('admin-dashboard').classList.remove('hidden');
            document.body.classList.add('admin-view');
            loadAdminData();
        }

        // --- FORM LOGIC (SAMA SEPERTI SEBELUMNYA DENGAN PENYESUAIAN) ---
        
        document.getElementById('parkingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!this.checkValidity()) {
                alert('Mohon lengkapi semua kolom yang wajib diisi (termasuk Foto Identitas).');
                return;
            }

            // Validasi tambahan: Pastikan email tersimpan
            if (!currentUserEmail) {
                alert("Sesi login berakhir. Silakan refresh halaman dan login kembali.");
                return;
            }

            if(confirm("Apakah data yang Anda masukkan sudah benar?\n\nKlik OK untuk mengirim.")) {
                const formData = new FormData(this);
                await submitFinalData(formData);
            }
        });

        async function submitFinalData(formData) {
            showLoading(true, "Mengirim data ke server...");
            const formDataObject = Object.fromEntries(formData.entries());
            
            try {
                // Handle File Upload
                const fileInput = formData.get('fileKtp');
                if (fileInput && fileInput.size > 0) {
                    formDataObject.fileKtp = await compressAndReadFile(fileInput);
                }

                const response = await fetch(WEB_APP_URL, { 
                    method: 'POST', 
                    body: JSON.stringify(formDataObject) 
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    alert('Pengajuan Berhasil! Terima kasih.');
                    document.getElementById('parkingForm').reset();
                    document.getElementById('namaLengkap').value = localStorage.getItem('userName') || ''; // Reset nama kembali
                    document.getElementById('emailAkunGoogle').value = currentUserEmail; // Reset email
                    toggleSections();
                } else { 
                    throw new Error(result.message); 
                }
            } catch(error) {
                alert('Gagal mengirim: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // --- ADMIN LOGIC ---
        async function loadAdminData() {
            await loadSettings();
            await fetchPage(1);
        }

        async function loadSettings() {
            try {
                const response = await fetch(`${WEB_APP_URL}?action=getSettings`);
                const result = await response.json();
                if (result.status === 'success') {
                    const status = result.data.formStatus;
                    const btn = document.getElementById('toggle-form-btn');
                    btn.textContent = `Status Formulir: ${status}`;
                    btn.style.background = status === 'ON' ? 'var(--success-color)' : 'var(--error-color)';
                    btn.dataset.status = status;
                }
            } catch (e) { console.error(e); }
        }

        async function toggleFormStatus() {
            const currentStatus = document.getElementById('toggle-form-btn').dataset.status;
            const newStatus = currentStatus === 'ON' ? 'OFF' : 'ON';
            showLoading(true, 'Mengupdate status...');
            try {
                await fetch(`${WEB_APP_URL}?action=updateSettings&formStatus=${newStatus}`);
                await loadSettings();
            } catch (e) { alert("Gagal update status"); }
            finally { showLoading(false); }
        }

        async function fetchPage(page) {
            currentPage = page;
            showLoading(true, "Mengambil data...");
            const searchTerm = document.getElementById('search-input').value;
            const status = document.getElementById('status-filter').value;
            
            try {
                const url = `${WEB_APP_URL}?action=getSubmissions&page=${page}&searchTerm=${encodeURIComponent(searchTerm)}&statusFilter=${encodeURIComponent(status)}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.status === 'success') {
                    submissionHeaders = result.data.headers;
                    renderTable(result.data.pageData);
                    renderPagination(result.data.currentPage, result.data.totalPages);
                }
            } catch(e) { console.error(e); }
            finally { showLoading(false); }
        }

        function renderTable(data) {
            const tbody = document.querySelector('#submissions-table tbody');
            const thead = document.querySelector('#submissions-table thead');
            tbody.innerHTML = '';
            
            if(!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;">Tidak ada data.</td></tr>';
                return;
            }

            // Render Header
            thead.innerHTML = `<tr>${submissionHeaders.map(h => `<th>${h}</th>`).join('')}</tr>`;

            // Render Rows
            data.forEach(item => {
                const tr = document.createElement('tr');
                item.rowData.forEach((cell, idx) => {
                    const td = document.createElement('td');
                    td.setAttribute('data-label', submissionHeaders[idx]);
                    
                    if (submissionHeaders[idx] === 'Status') {
                        const select = document.createElement('select');
                        select.innerHTML = `<option value="Belum diproses">Belum diproses</option><option value="Selesai">Selesai</option><option value="Ditolak">Ditolak</option><option value="Hapus">Hapus</option>`;
                        select.value = cell;
                        select.onchange = (e) => updateStatus(e.target.value, item.originalIndex);
                        
                        // Styling select
                        select.className = cell === 'Selesai' ? 'status-selesai' : (cell === 'Ditolak' ? 'status-ditolak' : 'status-pending');
                        td.appendChild(select);
                    } else if (submissionHeaders[idx].includes('Link') && cell.includes('http')) {
                        td.innerHTML = `<a href="${cell}" target="_blank" style="color:var(--primary-color);font-weight:bold;">Lihat File</a>`;
                    } else {
                        td.textContent = cell;
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        function renderPagination(current, total) {
            const container = document.getElementById('pagination-controls');
            if (total <= 1) { container.innerHTML = ''; return; }
            container.innerHTML = `
                <button onclick="fetchPage(${current - 1})" ${current === 1 ? 'disabled' : ''} style="width:auto; display:inline-block;">&laquo;</button>
                <span style="margin: 0 10px;">Halaman ${current} dari ${total}</span>
                <button onclick="fetchPage(${current + 1})" ${current === total ? 'disabled' : ''} style="width:auto; display:inline-block;">&raquo;</button>
            `;
        }

        async function updateStatus(newStatus, rowIndex) {
            if(newStatus === 'Hapus' && !confirm("Yakin ingin menghapus data ini permanen?")) {
                fetchPage(currentPage); return;
            }
            
            showLoading(true, "Menyimpan perubahan...");
            try {
                await fetch(`${WEB_APP_URL}?action=updateStatus&rowIndex=${rowIndex}&status=${newStatus}`);
                if(newStatus === 'Hapus') fetchPage(currentPage);
            } catch(e) { alert("Gagal update status"); }
            finally { showLoading(false); }
        }

        document.getElementById('download-xlsx').addEventListener('click', async () => {
            showLoading(true, "Mendownload...");
            try {
                const response = await fetch(`${WEB_APP_URL}?action=downloadData`);
                const result = await response.json();
                if(result.status === 'success') {
                    const ws = XLSX.utils.aoa_to_sheet([result.data.headers, ...result.data.rows]);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Data Parkir");
                    XLSX.writeFile(wb, "Data_Parkir_RSUD.xlsx");
                }
            } catch(e) { alert("Gagal download"); }
            finally { showLoading(false); }
        });

        // --- UTILS ---
        async function checkFormStatusForUser() { 
            try { 
                const response = await fetch(`${WEB_APP_URL}?action=getSettings`); 
                const result = await response.json(); 
                const isOff = result.status === 'success' && result.data.formStatus === 'OFF'; 
                document.getElementById('parkingForm').classList.toggle('hidden', isOff); 
                document.getElementById('form-closed-message').classList.toggle('hidden', !isOff); 
            } catch(e) {} 
        }

        const formSections = { 
            update: document.getElementById('update-section'), 
            cardReplacement: document.getElementById('card-replacement-section'), 
            newVehicle: document.getElementById('new-vehicle-section'), 
            lainnya: document.getElementById('lainnya-section') 
        };

        function toggleSections(){ 
            const choice = document.querySelector('input[name="jenisPengajuan"]:checked')?.value; 
            handleRadioStyle(document.querySelector(`input[name="jenisPengajuan"][value="${choice}"]`)); 
            
            Object.values(formSections).forEach(s => s.classList.add('hidden')); 
            if (!choice) return; 
            
            if(['Pendaftaran Baru', 'Tambah Kendaraan Baru', 'Rubah Nomor Kendaraan'].includes(choice)) formSections.newVehicle.classList.remove('hidden');
            if(['Rubah Nomor Kendaraan', 'Hapus Nomor Kendaraan', 'Buat/Ganti Kartu Parkir'].includes(choice)) formSections.update.classList.remove('hidden');
            if(choice === 'Buat/Ganti Kartu Parkir') formSections.cardReplacement.classList.remove('hidden');
            if(choice === 'Lainnya') formSections.lainnya.classList.remove('hidden');
        }

        function handleStatusKepegawaianChange() { 
            const choice = document.querySelector('input[name="statusKepegawaian"]:checked')?.value; 
            const rsudSection = document.getElementById('rsud-employee-section'); 
            const otherSection = document.getElementById('other-employee-section'); 
            
            if (choice === 'Karyawan RSUD') { 
                rsudSection.classList.remove('hidden'); otherSection.classList.add('hidden'); 
                document.getElementById('unitKerja').required = true; 
                document.getElementById('afiliasiLainnya').required = false; 
            } else { 
                rsudSection.classList.add('hidden'); otherSection.classList.remove('hidden'); 
                document.getElementById('unitKerja').required = false; 
                document.getElementById('afiliasiLainnya').required = true; 
            } 
        }

        function handleUnitKerjaChange(select){ 
            const isLainnya = select.value === 'LAINNYA'; 
            document.getElementById('unitKerjaLainnya-group').classList.toggle('hidden', !isLainnya); 
            document.getElementById('unitKerjaLainnya').required = isLainnya; 
        }

        function handleAlasanChange() {
             const isLainnya = document.querySelector('input[name="alasanPenggantian"]:checked')?.value === 'Lainnya';
             document.getElementById('alasanLainnya-group').classList.toggle('hidden', !isLainnya);
             document.getElementById('alasanPenggantianLainnya').required = isLainnya;
        }

        function handleRadioStyle(radioElement) { 
            if (!radioElement) return; 
            const name = radioElement.name;
            document.querySelectorAll(`input[name="${name}"]`).forEach(r => r.parentElement.classList.remove('selected-label'));
            radioElement.parentElement.classList.add('selected-label');
        }

        function compressAndReadFile(file){ 
            return new Promise((resolve, reject) => { 
                const reader = new FileReader(); 
                reader.readAsDataURL(file); 
                reader.onload = event => { 
                    const img = new Image(); 
                    img.src = event.target.result; 
                    img.onload = () => { 
                        const canvas = document.createElement('canvas'); 
                        const ctx = canvas.getContext('2d'); 
                        const scale = 1024 / img.width; 
                        canvas.width = 1024; 
                        canvas.height = img.height * scale; 
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height); 
                        resolve({ base64: canvas.toDataURL('image/jpeg', 0.7).split(',')[1], type: 'image/jpeg', name: 'id_card.jpg' }); 
                    }; 
                }; 
                reader.onerror = error => reject(error); 
            }); 
        }

        function showLoading(show, message) { 
            const ol = document.getElementById('loading-overlay'); 
            ol.style.display = show ? 'flex' : 'none'; 
            ol.querySelector('p').textContent = message || 'Loading...'; 
        }
    </script>
</body>
</html>
